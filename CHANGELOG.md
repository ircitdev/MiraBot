# Changelog

## [1.7.1] - 2025-12-20

### Добавлено

#### Улучшения WebApp

**Визуализация программ:**
- **Новый API `/api/programs/`** — список программ с прогрессом
- **Секция "Мои программы"** в статистике WebApp
- Карточки программ с прогресс-барами и индикаторами дней
- Статусы: активна, завершена, на паузе, отменена
- Сводка: количество активных и завершённых программ

**Расширенные графики настроения:**
- **Переключатель периода:** 7 / 14 / 30 дней
- **Линия тренда** (скользящее среднее)
- **Сводка:** среднее за период, тренд (↗ улучшение / ↘ ухудшение)
- Адаптивные подписи дат для больших периодов

### Новые файлы
```
webapp/api/routes/programs.py   # API для программ
```

### Обновлённые файлы
- `webapp/api/main.py` — регистрация /api/programs
- `webapp/frontend/index.html` — секция программ, переключатель периода
- `webapp/frontend/styles.css` — стили программ и переключателя
- `webapp/frontend/app.js` — loadPrograms(), loadMoodChart(), updateMoodSummary()

---

## [1.7.0] - 2025-12-20

### Добавлено

#### Структурированные программы

**Модуль программ/курсов:**
- **Новая модель `UserProgram`** — отслеживание прогресса в программах
- **Команда `/programs`** — просмотр и запуск программ
- **Программа "7 дней заботы о себе":**
  - 7 дней практик для развития навыков самозаботы
  - Ежедневные задания с утренним сообщением
  - Микро-задачи на каждый день
  - Отслеживание прогресса
  - Настраиваемое время напоминаний
  - Возможность паузы и возобновления

**Новый функционал:**
- День 1: Осознанность тела (замечать сигналы)
- День 2: Потребности (не откладывать базовые нужды)
- День 3: Приятные мелочи (3 маленькие радости)
- День 4: Дыхательные практики
- День 5: Благодарность себе
- День 6: Границы (замечать желание сказать "нет")
- День 7: Выбор ритуалов на будущее

**Интеграция:**
- Автоматические напоминания через scheduler
- Кнопки inline для управления прогрессом
- Сообщение о завершении программы

### Новые файлы
```
database/models.py           # Добавлена модель UserProgram
database/repositories/program.py  # Репозиторий для программ
ai/programs/__init__.py      # Модуль программ
ai/programs/catalog.py       # Каталог программ
ai/programs/self_care_7_days.py   # "7 дней заботы о себе"
bot/handlers/programs.py     # Handlers для /programs
```

### Обновлённые файлы
- `bot/main.py` — регистрация команды /programs
- `services/scheduler.py` — задача send_program_tasks

---

## [1.6.0] - 2025-12-20

### Добавлено

#### Фаза 5: Профессиональные границы и безопасность

**Защита границ (на основе стресс-тестов):**
- **Защита от флирта и переноса:**
  - Распознавание романтических намёков, комплиментов внешности
  - Шаблон ответа: признать потребность в близости → вернуть к рабочему фокусу
  - Запрет на роль "виртуального мужа/друга"

- **Защита от агрессии:**
  - Распознавание оскорблений и грубости
  - Шаблон ответа: признать эмоцию → предложить разобраться в причине
  - Запрет на самоуничижение ("извини, я тупая")
  - Запрет на шутки в ответ на агрессию

- **Приоритизация ответов:**
  1. Кризисный протокол (суицид, насилие)
  2. Защита границ (флирт, агрессия)
  3. Инструменты помощи (техники, упражнения)
  4. Поддерживающая беседа

**Библиотека техник первой помощи:**
- **Новый модуль `ai/techniques_library.py`** — 12 психологических техник:
  - Заземление: 5-4-3-2-1, сканирование тела
  - Дыхание: квадратное, 4-7-8
  - Паника: холодная вода (diving reflex), безопасное место
  - Тревога: время для тревоги, худший сценарий
  - Злость: заземление через тело
  - Грусть: контейнер для чувств, само-объятие
  - Когнитивные: запись мыслей, декатастрофизация
- Интеграция в системный промпт с готовыми инструкциями

**Запрет галлюцинаций памяти:**
- Запрет на выдумывание имён (мужа, детей, друзей)
- Правило: использовать только проверенную информацию
- При неизвестном имени — спросить или использовать описательно

### Новые файлы
```
ai/techniques_library.py     # Библиотека психологических техник
```

### Обновлённые файлы
- `ai/prompts/system_prompt.py` — железные правила, защита границ, техники

---

## [1.5.0] - 2025-12-19

### Добавлено

#### Осведомлённость о времени и дате
- **Новый модуль `ai/time_context.py`** — полный контекст времени для AI:
  - День недели (понедельник-воскресенье) на русском
  - Время суток с рекомендациями по тону
  - Определение выходных дней
  - Российские праздники (Новый год, 8 марта, 9 мая, День России и др.)
  - Вычисление времени с последнего сообщения
  - Контекстные подсказки (утро понедельника, пятница вечер)
- Бот теперь понимает когда закончился день и начался новый
- Автоматические подсказки для приветствий после долгого перерыва

#### Медицинский фильтр
- **Новый модуль `ai/medical_filter.py`** — защита от медицинских советов:
  - Детекция медицинских тем в сообщениях
  - Фильтрация опасных советов (лекарства, дозировки)
  - Автоматическое добавление дисклеймера
- Инструкции в системном промпте о медицинских темах
- Интеграция в `claude_client.py` для обоих режимов (обычный и streaming)

#### Bi-weekly сводки прогресса
- **Новый модуль `ai/summary_generator.py`** — персонализированные сводки:
  - Анализ настроения за 2 недели
  - Топ эмоций и тем
  - Определение трендов (улучшение/ухудшение)
- Автоматическая отправка каждый понедельник в 19:00

### Исправлено

#### По отзывам пользователей
- **Стикеры в серьёзных контекстах** — добавлена фильтрация:
  - Новый список `SERIOUS_CONTEXT_MARKERS` в `sticker_sender.py`
  - Стикеры не отправляются при тяжёлых темах (кризис, развод, болезнь)
- **Путаница времени** — бот теперь различает прошлое/настоящее:
  - Добавлены маркеры прошлого/будущего в промпт
  - Инструкции по работе с временем в рассказах
- **Хинты в серьёзных разговорах** — добавлена фильтрация в `hint_generator.py`
- **Предположения о возрасте** — бот не угадывает возраст без фактов

### Новые файлы
```
ai/time_context.py           # Контекст времени
ai/medical_filter.py         # Медицинский фильтр
ai/summary_generator.py      # Генератор сводок
```

### Обновлённые файлы
- `ai/memory/context_builder.py` — интеграция time_context
- `ai/prompts/system_prompt.py` — расширенный блок времени, медтемы
- `ai/claude_client.py` — интеграция medical_filter
- `services/sticker_sender.py` — фильтрация серьёзных контекстов
- `ai/hint_generator.py` — фильтрация серьёзных контекстов
- `services/scheduler.py` — задача bi-weekly summaries

---

## [Unreleased] - 2025-12-14

### Добавлено

#### Trial период Premium
- Новые пользователи получают 3 дня Premium бесплатно при регистрации
- Автоматическая конвертация trial в free после истечения срока
- UI уведомления о trial периоде в `/start` и `/subscription`
- Напоминания об истечении trial подписки

#### WebApp - Настройки и Статистика
- **Полноценное веб-приложение** на `https://mira.uspeshnyy.ru`
- **Статистика:**
  - Общее количество сообщений и за неделю
  - График настроения за последние 7 дней
  - Топ обсуждаемых тем
  - Распределение эмоций
  - Статус подписки с оставшимися днями
- **Настройки:**
  - Выбор персоны (Мира/Марк)
  - Имя пользователя и данные партнёра
  - Праздничные даты (день рождения, годовщина)
  - Управление ритуалами (утренние/вечерние check-in)
  - Время для ритуалов
  - Проактивные сообщения
- **Интеграция:**
  - Кнопка меню "⚙️ Настройки" в боте
  - Команда `/settings` открывает WebApp
  - Безопасность через Telegram WebApp initData

#### Улучшения хинтов (контекстных кнопок)
- Убраны универсальные хинты — показываются только релевантные контексту
- Улучшена логика определения контекста
- Хинты не показываются на простые вопросы Миры
- Добавлены паттерны для различных сценариев

### Изменено

#### Музыка
- **ОТКЛЮЧЕНА** автоматическая отправка музыки
- Удалены все триггеры музыки из хинтов
- Музыка больше не отправляется при упоминании в разговоре

#### Система подписок
- Trial подписка даёт все возможности Premium
- Проверка `is_premium` включает trial

#### Конфигурация
- Добавлены настройки WebApp в `config/settings.py`:
  - `WEBAPP_DOMAIN` - домен для WebApp
  - `WEBAPP_PORT` - порт WebApp сервера

### Исправлено
- Circular import в WebApp (вынесен auth в отдельный модуль)
- Проблема с отображением эмодзи в хинтах
- PID lock для предотвращения множественных запусков бота

### Технические детали

#### Новые файлы
```
webapp/
├── api/
│   ├── main.py           # FastAPI приложение
│   ├── auth.py           # Авторизация через Telegram
│   └── routes/
│       ├── settings.py   # API настроек
│       └── stats.py      # API статистики
├── frontend/
│   ├── index.html        # UI приложения
│   ├── styles.css        # Стили с Telegram темой
│   └── app.js            # Логика и API клиент
├── run_server.py         # Запуск сервера
└── README.md             # Документация WebApp
```

#### Обновлённые файлы
- `database/repositories/user.py` - создание trial подписки
- `bot/handlers/message.py` - отключена музыка, trial = premium
- `bot/handlers/start.py` - уведомление о trial, убрано "виртуальная"
- `bot/handlers/commands.py` - WebApp кнопка в `/settings`
- `services/scheduler.py` - задача конвертации trial
- `ai/hint_generator.py` - улучшенная логика хинтов

#### Деплой
- systemd service: `mira-webapp.service`
- nginx config: `/etc/nginx/sites-available/mira-webapp`
- Домен: `https://mira.uspeshnyy.ru`
- SSL: сертификат smit34.ru (временно)

### Миграции
Не требуется - модель Subscription уже поддерживала plan='trial'

### Конфигурация

Добавить в `.env`:
```env
WEBAPP_DOMAIN=mira.uspeshnyy.ru
WEBAPP_PORT=8081
```

### Зависимости
Без изменений (uvicorn уже был в requirements.txt)
