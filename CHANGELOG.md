# Changelog

## [1.5.0] - 2025-12-19

### Добавлено

#### Осведомлённость о времени и дате
- **Новый модуль `ai/time_context.py`** — полный контекст времени для AI:
  - День недели (понедельник-воскресенье) на русском
  - Время суток с рекомендациями по тону
  - Определение выходных дней
  - Российские праздники (Новый год, 8 марта, 9 мая, День России и др.)
  - Вычисление времени с последнего сообщения
  - Контекстные подсказки (утро понедельника, пятница вечер)
- Бот теперь понимает когда закончился день и начался новый
- Автоматические подсказки для приветствий после долгого перерыва

#### Медицинский фильтр
- **Новый модуль `ai/medical_filter.py`** — защита от медицинских советов:
  - Детекция медицинских тем в сообщениях
  - Фильтрация опасных советов (лекарства, дозировки)
  - Автоматическое добавление дисклеймера
- Инструкции в системном промпте о медицинских темах
- Интеграция в `claude_client.py` для обоих режимов (обычный и streaming)

#### Bi-weekly сводки прогресса
- **Новый модуль `ai/summary_generator.py`** — персонализированные сводки:
  - Анализ настроения за 2 недели
  - Топ эмоций и тем
  - Определение трендов (улучшение/ухудшение)
- Автоматическая отправка каждый понедельник в 19:00

### Исправлено

#### По отзывам пользователей
- **Стикеры в серьёзных контекстах** — добавлена фильтрация:
  - Новый список `SERIOUS_CONTEXT_MARKERS` в `sticker_sender.py`
  - Стикеры не отправляются при тяжёлых темах (кризис, развод, болезнь)
- **Путаница времени** — бот теперь различает прошлое/настоящее:
  - Добавлены маркеры прошлого/будущего в промпт
  - Инструкции по работе с временем в рассказах
- **Хинты в серьёзных разговорах** — добавлена фильтрация в `hint_generator.py`
- **Предположения о возрасте** — бот не угадывает возраст без фактов

### Новые файлы
```
ai/time_context.py           # Контекст времени
ai/medical_filter.py         # Медицинский фильтр
ai/summary_generator.py      # Генератор сводок
```

### Обновлённые файлы
- `ai/memory/context_builder.py` — интеграция time_context
- `ai/prompts/system_prompt.py` — расширенный блок времени, медтемы
- `ai/claude_client.py` — интеграция medical_filter
- `services/sticker_sender.py` — фильтрация серьёзных контекстов
- `ai/hint_generator.py` — фильтрация серьёзных контекстов
- `services/scheduler.py` — задача bi-weekly summaries

---

## [Unreleased] - 2025-12-14

### Добавлено

#### Trial период Premium
- Новые пользователи получают 3 дня Premium бесплатно при регистрации
- Автоматическая конвертация trial в free после истечения срока
- UI уведомления о trial периоде в `/start` и `/subscription`
- Напоминания об истечении trial подписки

#### WebApp - Настройки и Статистика
- **Полноценное веб-приложение** на `https://mira.uspeshnyy.ru`
- **Статистика:**
  - Общее количество сообщений и за неделю
  - График настроения за последние 7 дней
  - Топ обсуждаемых тем
  - Распределение эмоций
  - Статус подписки с оставшимися днями
- **Настройки:**
  - Выбор персоны (Мира/Марк)
  - Имя пользователя и данные партнёра
  - Праздничные даты (день рождения, годовщина)
  - Управление ритуалами (утренние/вечерние check-in)
  - Время для ритуалов
  - Проактивные сообщения
- **Интеграция:**
  - Кнопка меню "⚙️ Настройки" в боте
  - Команда `/settings` открывает WebApp
  - Безопасность через Telegram WebApp initData

#### Улучшения хинтов (контекстных кнопок)
- Убраны универсальные хинты — показываются только релевантные контексту
- Улучшена логика определения контекста
- Хинты не показываются на простые вопросы Миры
- Добавлены паттерны для различных сценариев

### Изменено

#### Музыка
- **ОТКЛЮЧЕНА** автоматическая отправка музыки
- Удалены все триггеры музыки из хинтов
- Музыка больше не отправляется при упоминании в разговоре

#### Система подписок
- Trial подписка даёт все возможности Premium
- Проверка `is_premium` включает trial

#### Конфигурация
- Добавлены настройки WebApp в `config/settings.py`:
  - `WEBAPP_DOMAIN` - домен для WebApp
  - `WEBAPP_PORT` - порт WebApp сервера

### Исправлено
- Circular import в WebApp (вынесен auth в отдельный модуль)
- Проблема с отображением эмодзи в хинтах
- PID lock для предотвращения множественных запусков бота

### Технические детали

#### Новые файлы
```
webapp/
├── api/
│   ├── main.py           # FastAPI приложение
│   ├── auth.py           # Авторизация через Telegram
│   └── routes/
│       ├── settings.py   # API настроек
│       └── stats.py      # API статистики
├── frontend/
│   ├── index.html        # UI приложения
│   ├── styles.css        # Стили с Telegram темой
│   └── app.js            # Логика и API клиент
├── run_server.py         # Запуск сервера
└── README.md             # Документация WebApp
```

#### Обновлённые файлы
- `database/repositories/user.py` - создание trial подписки
- `bot/handlers/message.py` - отключена музыка, trial = premium
- `bot/handlers/start.py` - уведомление о trial, убрано "виртуальная"
- `bot/handlers/commands.py` - WebApp кнопка в `/settings`
- `services/scheduler.py` - задача конвертации trial
- `ai/hint_generator.py` - улучшенная логика хинтов

#### Деплой
- systemd service: `mira-webapp.service`
- nginx config: `/etc/nginx/sites-available/mira-webapp`
- Домен: `https://mira.uspeshnyy.ru`
- SSL: сертификат smit34.ru (временно)

### Миграции
Не требуется - модель Subscription уже поддерживала plan='trial'

### Конфигурация

Добавить в `.env`:
```env
WEBAPP_DOMAIN=mira.uspeshnyy.ru
WEBAPP_PORT=8081
```

### Зависимости
Без изменений (uvicorn уже был в requirements.txt)
