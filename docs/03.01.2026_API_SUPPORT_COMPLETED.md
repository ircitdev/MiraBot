# API для поддержки - Завершено 03.01.2026

## ✅ Выполнено

### 1. API Endpoints для раздела "Вопросы"

**Файл:** `webapp/api/routes/support.py`

#### 1.1. GET `/api/support/questions`
- Получить список всех обращений в поддержку
- Требует авторизацию администратора
- Параметры:
  - `page` (int, default=1) - номер страницы
  - `limit` (int, default=20, max=100) - количество на странице
- Возвращает:
  - `total` - общее количество обращений
  - `page` - текущая страница
  - `per_page` - количество на странице
  - `questions` - массив объектов SupportUserItem

#### 1.2. GET `/api/support/questions/{user_id}/messages`
- Получить историю сообщений конкретного пользователя
- Требует авторизацию администратора
- Параметры:
  - `user_id` (path) - ID пользователя поддержки
  - `page` (int, default=1) - номер страницы
  - `limit` (int, default=50, max=200) - количество сообщений
- Возвращает:
  - `total` - общее количество сообщений
  - `page` - текущая страница
  - `per_page` - количество на странице
  - `messages` - массив объектов SupportMessageItem
  - `user_info` - информация о пользователе (SupportUserItem)

---

### 2. API Endpoints для раздела "Отзывы"

**Файл:** `webapp/api/routes/reviews.py`

#### 2.1. GET `/api/support/reviews`
- Получить список отзывов с фильтрацией
- Требует авторизацию администратора
- Параметры:
  - `page` (int, default=1) - номер страницы
  - `limit` (int, default=20, max=100) - количество на странице
  - `permission` (bool, optional) - фильтр по разрешению на публикацию
    - `null` - все отзывы
    - `true` - только с разрешением
    - `false` - только без разрешения
- Возвращает:
  - `total` - общее количество отзывов
  - `page` - текущая страница
  - `per_page` - количество на странице
  - `reviews` - массив объектов SupportReviewItem

#### 2.2. GET `/api/support/public/reviews`
- Публичный эндпоинт для лендинга (БЕЗ авторизации)
- Параметры:
  - `limit` (int, default=10, max=100) - количество отзывов
- Возвращает: массив объектов PublicReviewItem
  - `name` - "Александр, 35 лет" или "Аноним"
  - `about` - о себе
  - `text` - текст отзыва
  - `date` - "03.01.2026"

---

### 3. Pydantic Models

#### SupportUserItem
```python
{
    "user_id": int,
    "telegram_id": int,
    "first_name": str,
    "last_name": str | null,
    "username": str | null,
    "photo_url": str | null,
    "topic_id": int,
    "total_messages": int,
    "last_message_date": datetime | null,
    "last_message_text": str | null,
    "is_bot_blocked": bool
}
```

#### SupportMessageItem
```python
{
    "id": int,
    "sender_type": "user" | "admin",
    "message_text": str | null,
    "media_type": "text" | "photo" | "video" | "voice" | "video_note" | "document" | "sticker",
    "media_file_id": str | null,
    "created_at": datetime
}
```

#### SupportReviewItem
```python
{
    "id": int,
    "user_id": int | null,
    "username": str | null,
    "age": int | null,
    "about_self": str | null,
    "review_text": str,
    "permission_to_publish": bool,
    "created_at": datetime,
    "telegram_message_id": int | null
}
```

#### PublicReviewItem
```python
{
    "name": str,         # "Александр, 35 лет"
    "about": str,        # О себе
    "text": str,         # Текст отзыва
    "date": str          # "03.01.2026"
}
```

---

### 4. Регистрация роутов

**Файл:** `webapp/api/main.py`

```python
app.include_router(support.router, prefix="/api/support", tags=["support"])
app.include_router(reviews.router, prefix="/api/support", tags=["reviews"])
```

---

### 5. Исправления

1. **Импорты в API:**
   - Заменено `@require_admin` на `Depends(get_current_admin)`
   - Импорт из `webapp.api.middleware`

2. **Импорты в репозиториях:**
   - Заменено `from database.core import get_session`
   - На `from database.session import get_session_context`
   - Заменено `async with get_session()`
   - На `async with get_session_context()`

3. **Файлы с исправлениями:**
   - `database/repositories/support_user.py`
   - `database/repositories/support_message.py`
   - `database/repositories/support_review.py`

---

### 6. Тестирование

✅ **Публичный эндпоинт:**
```bash
curl http://localhost:8081/api/support/public/reviews?limit=5
# Ответ: []
```

✅ **Webapp запущен без ошибок:**
```
INFO:     Application startup complete.
```

---

### 7. Доступ к API

- **Swagger UI:** https://miradrug.ru/docs
- **Endpoints:**
  - GET `https://miradrug.ru/api/support/questions` (требует auth)
  - GET `https://miradrug.ru/api/support/questions/{user_id}/messages` (требует auth)
  - GET `https://miradrug.ru/api/support/reviews` (требует auth)
  - GET `https://miradrug.ru/api/support/public/reviews` (публичный)

---

### 8. Следующие шаги

**Этап 5: UI для админки**
- [ ] Добавить раздел "Поддержка" в меню
- [ ] Создать подраздел "Вопросы" с аккордеоном
- [ ] Создать подраздел "Отзывы" с карточками
- [ ] Добавить настройки в раздел "Конфиг"

---

## Время работы

- **Начало:** 03.01.2026 ~16:10
- **Завершение:** 03.01.2026 ~16:30
- **Длительность:** ~20 минут

## Изменённые файлы

### Новые файлы:
- `webapp/api/routes/support.py`
- `webapp/api/routes/reviews.py`

### Изменённые файлы:
- `webapp/api/main.py` (добавлены роуты)
- `database/repositories/support_user.py` (исправлены импорты)
- `database/repositories/support_message.py` (исправлены импорты)
- `database/repositories/support_review.py` (исправлены импорты)
