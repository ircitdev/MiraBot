# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ API –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

**–î–∞—Ç–∞:** 30.12.2025
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–ª–æ–Ω–∫–∞ API –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ –Ω—É–ª–∏

## –ü—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

1. **–¢–∞–±–ª–∏—Ü–∞ api_costs –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞** - –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. **–û—à–∏–±–∫–∏ –≤ –º–∏–≥—Ä–∞—Ü–∏—è—Ö** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å SQLite —Ñ—É–Ω–∫—Ü–∏–π (`now()` –≤–º–µ—Å—Ç–æ `CURRENT_TIMESTAMP`)
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Yandex TTS** - —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–ª —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ó–∞–º–µ–Ω–µ–Ω—ã –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å SQLite –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:

**–§–∞–π–ª:** `database/migrations/versions/20241214_mood_entries.py:35`
```python
# –ë—ã–ª–æ: sa.text('now()')
# –°—Ç–∞–ª–æ: sa.text('CURRENT_TIMESTAMP')
```

**–§–∞–π–ª:** `database/migrations/versions/20251215_add_user_goals.py:42-43`
```python
# –ë—ã–ª–æ: sa.func.now()
# –°—Ç–∞–ª–æ: sa.text('CURRENT_TIMESTAMP')
```

**–§–∞–π–ª:** `database/migrations/versions/20251215_add_user_followups.py:36-37`
```python
# –ë—ã–ª–æ: sa.func.now()
# –°—Ç–∞–ª–æ: sa.text('CURRENT_TIMESTAMP')
```

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
alembic stamp 20251229_add_admin_users_and_logs
alembic upgrade head
```

–°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `api_costs` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (FK –Ω–∞ users.id)
- `provider` - –ø—Ä–æ–≤–∞–π–¥–µ—Ä API (claude, yandex_tts, yandex_stt, openai)
- `operation` - —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (chat_completion, text_to_speech, etc.)
- `input_tokens`, `output_tokens`, `total_tokens` - –¥–ª—è LLM API
- `characters_count` - –¥–ª—è TTS/STT
- `audio_seconds` - –¥–ª—è STT
- `cost_usd` - —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê
- `model` - –º–æ–¥–µ–ª—å API
- `message_id` - —Å–≤—è–∑—å —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `admin_user_id` - ID –∞–¥–º–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `created_at` - –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Yandex TTS

**–§–∞–π–ª:** `services/tts_yandex.py`

–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- –ò–º–ø–æ—Ä—Ç `ApiCostRepository`
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –≤ `__init__`
- –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ `_track_api_cost()` –¥–ª—è –∑–∞–ø–∏—Å–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `user_id` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `synthesize()`, `text_to_voice_bytes()` –∏ `send_voice_message()`
- –í—ã–∑–æ–≤ —Ç—Ä–µ–∫–∏–Ω–≥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏

–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏:
```python
# Yandex TTS: $0.12 –∑–∞ 1 –º–∏–ª–ª–∏–æ–Ω —Å–∏–º–≤–æ–ª–æ–≤
cost_usd = (characters_count / 1_000_000) * 0.12
```

### 4. Claude API —É–∂–µ –∏–º–µ–ª –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í `ai/claude_client.py` —É–∂–µ –±—ã–ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `_track_api_cost()` –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤:
- `generate_response()` - –æ–±—ã—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- `generate_response_stream()` - –ø–æ—Ç–æ–∫–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
- –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ Claude Sonnet 4:
```python
# Input: $3 per million tokens
# Output: $15 per million tokens
input_cost = (input_tokens / 1_000_000) * 3.0
output_cost = (output_tokens / 1_000_000) * 15.0
total_cost = input_cost + output_cost
```

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
- –¢–∞–±–ª–∏—Ü–∞ `api_costs` —Å–æ–∑–¥–∞–Ω–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –¥–∞–Ω–Ω—ã–µ:
  - `GET /api/admin/api-costs/users/summary` - —Å–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  - `GET /api/admin/api-costs/users/{telegram_id}` - —Ä–∞—Å—Ö–æ–¥—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `GET /api/admin/api-costs/stats` - –æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  - `GET /api/admin/api-costs/by-date` - —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –¥–∞—Ç–∞–º (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞)
  - `GET /api/admin/api-costs/top-users` - —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º
- Claude API –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- Yandex TTS –ª–æ–≥–∏—Ä—É–µ—Ç —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–∏ —Å–∏–Ω—Ç–µ–∑–µ —Ä–µ—á–∏
- –ö–æ–ª–æ–Ω–∫–∞ API –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

### üìä –ü—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å:
```
User 1 (TG: 65876198): $0.002468
  - Input tokens: 100
  - Output tokens: 200
  - Total tokens: 300
  - Provider: claude
  - Model: claude-sonnet-4-20250514
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è:
1. **Yandex STT** (Speech-to-Text) - –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
2. **OpenAI API** - –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
3. **–î—Ä—É–≥–∏–µ –ø–ª–∞—Ç–Ω—ã–µ API** - –µ—Å–ª–∏ –µ—Å—Ç—å

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. **–ë—é–¥–∂–µ—Ç–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤
2. **–î–∞—à–±–æ—Ä–¥ —Ä–∞—Å—Ö–æ–¥–æ–≤** - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–Ω–¥–æ–≤
3. **–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö** - –≤—ã–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ CSV/Excel
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –∞–Ω–∞–ª–∏–∑ –∏ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- `test_api_tracking.py` - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- `check_users_api.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏
- `check_api_costs.py` - –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –¥–ª—è Windows)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
1. –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
2. –ü–µ—Ä–µ–π—Ç–∏ –≤ —Ä–∞–∑–¥–µ–ª "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
3. –ö–æ–ª–æ–Ω–∫–∞ "API" —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
4. –í–∫–ª–∞–¥–∫–∞ "–†–∞—Å—Ö–æ–¥—ã API" –≤ —Ä–∞–∑–¥–µ–ª–µ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ò–∑–º–µ–Ω–µ–Ω—ã:
- `database/migrations/versions/20241214_mood_entries.py`
- `database/migrations/versions/20251215_add_user_goals.py`
- `database/migrations/versions/20251215_add_user_followups.py`
- `services/tts_yandex.py`

### –°–æ–∑–¥–∞–Ω—ã:
- `test_api_tracking.py`
- `check_users_api.py`
- `test_api_costs.py`
- `docs/30.12.25/API_COSTS_FIX.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

### –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—É–∂–µ —Ä–∞–±–æ—Ç–∞–ª–æ):
- `ai/claude_client.py` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∂–µ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- `database/repositories/api_cost.py` - —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –±—ã–ª –≥–æ—Ç–æ–≤
- `webapp/api/routes/api_costs.py` - —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –±—ã–ª–∏ –≥–æ—Ç–æ–≤—ã
- `webapp/frontend/admin.html` - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—ã–ª –≥–æ—Ç–æ–≤
