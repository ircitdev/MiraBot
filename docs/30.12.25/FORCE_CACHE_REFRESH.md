# Принудительное обновление кеша браузера

**Дата:** 30.12.2025
**Проблема:** Браузер показывает старую версию admin.html несмотря на заголовки no-cache

## Решение

### 1. Обновлены заголовки HTTP (webapp/api/main.py)

Добавлен динамический ETag для принудительного обновления:

```python
@app.get("/admin")
async def admin_panel():
    """Админ-панель."""
    import time
    return FileResponse(
        webapp_dir / "frontend" / "admin.html",
        headers={
            "Cache-Control": "no-cache, no-store, must-revalidate, max-age=0",
            "Pragma": "no-cache",
            "Expires": "0",
            "X-Content-Type-Options": "nosniff",
            "ETag": f'"{int(time.time())}"'  # Меняется каждую секунду
        }
    )
```

### 2. Как применить изменения

#### Шаг 1: Перезапустить веб-сервер

Веб-приложение нужно перезапустить, чтобы изменения в `main.py` вступили в силу.

**Если запущено через systemd:**
```bash
sudo systemctl restart mira-webapp
```

**Если запущено вручную:**
```bash
# Остановить текущий процесс (Ctrl+C)
# Запустить снова
python -m uvicorn webapp.api.main:app --host 0.0.0.0 --port 8000
```

#### Шаг 2: Очистить кеш браузера

После перезапуска сервера, откройте админку и сделайте **жесткую перезагрузку**:

1. Откройте: `http://mira.uspeshnyy.ru/admin`
2. Нажмите `Ctrl + Shift + R` (или `Ctrl + F5`)
3. Или через DevTools (F12):
   - Правый клик на кнопке "Обновить"
   - Выбрать "Очистить кеш и жесткая перезагрузка"

### 3. Проверка результата

После обновления вы должны увидеть:

#### В таблице пользователей (колонка API):
- ✅ `$0.00` (2 знака) вместо `$0.0000` (4 знака)

#### На дашборде (карточка API расходы):
```
API расходы
───────────────
За день:    $X.XX
За неделю:  $X.XX
За месяц:   $X.XX
```

#### В разделе Аналитика → Расходы API:
- ✅ График загружается без ошибок
- ✅ Статистика показывает данные
- ✅ Все суммы в формате `$X.XX`

## Технические детали

### Зачем нужен динамический ETag?

ETag (Entity Tag) - это HTTP заголовок, который браузер использует для определения, изменился ли файл.

**Проблема:** Некоторые браузеры кешируют HTML файлы агрессивно, игнорируя `Cache-Control: no-cache`.

**Решение:** Генерируем новый ETag при каждом запросе (на основе текущего времени), что заставляет браузер считать файл "измененным" и загружать его заново.

```python
"ETag": f'"{int(time.time())}"'
# Пример: "1735566234" (Unix timestamp)
```

### Альтернативные решения

Если проблема сохраняется, можно добавить query параметр к URL:

```
http://mira.uspeshnyy.ru/admin?v=2
```

Или очистить кеш браузера полностью через настройки.

## Файлы изменений

- `webapp/api/main.py` (строки 60-73) - добавлены дополнительные заголовки и динамический ETag
