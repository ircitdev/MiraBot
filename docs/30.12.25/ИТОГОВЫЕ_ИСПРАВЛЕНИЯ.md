# ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è API costs

**–î–∞—Ç–∞:** 30.12.2025
**–í—Å–µ —Ñ–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä**

## üìù –°–ø–∏—Å–æ–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ URL –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ (admin.html)

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–≤–æ–π–Ω—ã–µ —Å–ª–µ—à–∏ –≤ URL –ø—Ä–∏ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏

**–§–∞–π–ª:** `webapp/frontend/admin.html` (—Å—Ç—Ä–æ–∫–∏ 7654-7656)

**–ë—ã–ª–æ:**
```javascript
const response = await fetch(`${API_BASE}${endpoint}`, {
```

**–°—Ç–∞–ª–æ:**
```javascript
// Ensure proper URL construction without double slashes
const url = `${API_BASE}/${endpoint}`.replace(/([^:]\/)\/+/g, '$1');
const response = await fetch(url, {
```

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç:**
- `/api/adminapi-costs` ‚Üí `/api/admin/api-costs` ‚úÖ
- `/api/admin//users` ‚Üí `/api/admin/users` ‚úÖ
- `/api/admin//stats` ‚Üí `/api/admin/stats` ‚úÖ

### 2. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ISO —Ñ–æ—Ä–º–∞—Ç–∞ —Å timezone (api_costs.py)

**–ü—Ä–æ–±–ª–µ–º–∞:** 500 Internal Server Error –ø—Ä–∏ –¥–∞—Ç–∞—Ö —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º 'Z'

**–§–∞–π–ª:** `webapp/api/routes/api_costs.py`

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 3 —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö:**

#### a) GET /stats (—Å—Ç—Ä–æ–∫–∏ 130-135)

**–ë—ã–ª–æ:**
```python
if from_date:
    from_datetime = datetime.fromisoformat(from_date)
if to_date:
    to_datetime = datetime.fromisoformat(to_date)
```

**–°—Ç–∞–ª–æ:**
```python
if from_date:
    # –£–±–∏—Ä–∞–µ–º 'Z' –µ—Å–ª–∏ –µ—Å—Ç—å (ISO format —Å timezone)
    from_datetime = datetime.fromisoformat(from_date.replace('Z', '+00:00'))
if to_date:
    # –£–±–∏—Ä–∞–µ–º 'Z' –µ—Å–ª–∏ –µ—Å—Ç—å (ISO format —Å timezone)
    to_datetime = datetime.fromisoformat(to_date.replace('Z', '+00:00'))
```

#### b) GET /by-date (—Å—Ç—Ä–æ–∫–∏ 173-182)

**–ë—ã–ª–æ:**
```python
if not from_date:
    from_datetime = datetime.now() - timedelta(days=30)
else:
    from_datetime = datetime.fromisoformat(from_date)

if to_date:
    to_datetime = datetime.fromisoformat(to_date)
```

**–°—Ç–∞–ª–æ:**
```python
if not from_date:
    from_datetime = datetime.now() - timedelta(days=30)
else:
    # –£–±–∏—Ä–∞–µ–º 'Z' –µ—Å–ª–∏ –µ—Å—Ç—å (ISO format —Å timezone)
    from_datetime = datetime.fromisoformat(from_date.replace('Z', '+00:00'))

if to_date:
    # –£–±–∏—Ä–∞–µ–º 'Z' –µ—Å–ª–∏ –µ—Å—Ç—å (ISO format —Å timezone)
    to_datetime = datetime.fromisoformat(to_date.replace('Z', '+00:00'))
```

#### c) GET /top-users (—Å—Ç—Ä–æ–∫–∏ 227-232)

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.

**–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç:**
- `2025-12-22T17:03:34.487Z` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç—Å—è
- –ù–µ—Ç –±–æ–ª—å—à–µ 500 –æ—à–∏–±–æ–∫ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –¥–∞—Ç–∞–º–∏

## üöÄ –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ó–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:

1. ‚úÖ `webapp/frontend/admin.html` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è URL
2. ‚úÖ `webapp/api/routes/api_costs.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ISO —Ñ–æ—Ä–º–∞—Ç–∞ —Å 'Z'

### –°–µ—Ä–≤–µ—Ä:

‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω (`systemctl restart mira-webapp`)
‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç: `Active: active (running)`

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### 1. –ñ—ë—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!** –ë—Ä–∞—É–∑–µ—Ä –∫–µ—à–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—ã–π HTML —Ñ–∞–π–ª.

```
Ctrl + Shift + R
```

–ò–ª–∏ —á–µ—Ä–µ–∑ DevTools:
1. F12
2. –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –Ω–∞ "–û–±–Ω–æ–≤–∏—Ç—å"
3. "–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à –∏ –∂–µ—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞"

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å—ë –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:

#### ‚úÖ –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫
- –ö–æ–ª–æ–Ω–∫–∞ "API" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç $0.00 –∏–ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã

#### ‚úÖ –î–∞—à–±–æ—Ä–¥
–ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –¥–∞–Ω–Ω—ã–µ:
- –°–∏—Å—Ç–µ–º–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚úÖ
- API —Ä–∞—Å—Ö–æ–¥—ã (–¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü) ‚úÖ
- –¢–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö ‚úÖ

#### ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
–í—Å–µ –≤–∫–ª–∞–¥–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç:
- **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** - –≥—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ‚úÖ
- **–ü–æ–¥–ø–∏—Å–∫–∏** - –≥—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ‚úÖ
- **–†–∞—Å—Ö–æ–¥—ã API** - –≥—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ‚úÖ
- **–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ** - —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- **–≠–º–æ—Ü–∏–∏** - —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- **Top-—Ç–µ–≥–∏** - —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ

#### ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```
–î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –õ–∏–∑–∞
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
API –¢–æ–∫–µ–Ω–æ–≤:    0
API –†–∞—Å—Ö–æ–¥—ã:    $0.00
```

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ DevTools

F12 ‚Üí Network ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

**–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ 200 OK (–∑–µ–ª—ë–Ω—ã–º):**
- `/api/admin/users?limit=500` ‚Üí 200 OK ‚úÖ
- `/api/admin/stats/system` ‚Üí 200 OK ‚úÖ
- `/api/admin/analytics/activity?days=7` ‚Üí 200 OK ‚úÖ
- `/api/admin/analytics/subscriptions` ‚Üí 200 OK ‚úÖ
- `/api/admin/analytics/retention` ‚Üí 200 OK ‚úÖ
- `/api/admin/api-costs/stats?from_date=...` ‚Üí 200 OK ‚úÖ
- `/api/admin/api-costs/by-date?from_date=...` ‚Üí 200 OK ‚úÖ
- `/api/admin/api-costs/users/summary` ‚Üí 200 OK ‚úÖ

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- ‚ùå 404 Not Found (–∫—Ä–∞—Å–Ω—ã–º)
- ‚ùå 500 Internal Server Error (–∫—Ä–∞—Å–Ω—ã–º)
- ‚ùå –î–≤–æ–π–Ω—ã—Ö —Å–ª–µ—à–µ–π (`//`) –≤ –ø—É—Ç—è—Ö
- ‚ùå –°–ª–∏–ø—à–∏—Ö—Å—è —Å–ª–æ–≤ (`adminapi-costs`)

## üìä –û –ø—É—Å—Ç—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞—Ö

–ï—Å–ª–∏ –≥—Ä–∞—Ñ–∏–∫ "–†–∞—Å—Ö–æ–¥—ã API" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Å—Ç–æ—Ç—É - —ç—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ**!

–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –æ—á–µ–Ω—å –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö:
- –¢–æ–ª—å–∫–æ 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏ (telegram_id: 65876198)
- –†–∞—Å—Ö–æ–¥—ã –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ: $0.00 (–æ–∫—Ä—É–≥–ª–µ–Ω–æ –¥–æ 2 –∑–Ω–∞–∫–æ–≤)

### –ö–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ?

–î–∞–Ω–Ω—ã–µ –Ω–∞—á–Ω—É—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. **Claude API** - –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç—É
2. **Yandex TTS** - –∫–æ–≥–¥–∞ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

–ö–∞–∂–¥–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `api_costs` —Å –ø–æ–ª—è–º–∏:
- `provider` (claude / yandex_tts)
- `cost_usd` (—Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö)
- `total_tokens` (–¥–ª—è Claude)
- `characters_count` (–¥–ª—è Yandex TTS)
- `created_at` (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)

## üéØ –ò—Ç–æ–≥

‚úÖ **–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:**

1. ‚úÖ URL –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
2. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ISO —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç —Å timezone (Z)
3. ‚úÖ –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
4. ‚úÖ –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω

**–û—Å—Ç–∞–ª–æ—Å—å:**
- Ctrl + Shift + R (–∂—ë—Å—Ç–∫–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ —Å–µ–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

–í—Å—ë –≥–æ—Ç–æ–≤–æ! üéâ

## üìÑ –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

1. [–§–ò–ù–ê–õ–¨–ù–û–ï_–†–ï–®–ï–ù–ò–ï_URL_BUG.md](./–§–ò–ù–ê–õ–¨–ù–û–ï_–†–ï–®–ï–ù–ò–ï_URL_BUG.md) - –ø—Ä–æ URL –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—é
2. [CRITICAL_BUG_FIX_API_COSTS_URL.md](./CRITICAL_BUG_FIX_API_COSTS_URL.md) - –ø–µ—Ä–≤–∏—á–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
3. [API_COSTS_BUGFIX.md](./API_COSTS_BUGFIX.md) - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ .isoformat()
4. [FORCE_CACHE_REFRESH.md](./FORCE_CACHE_REFRESH.md) - –ø—Ä–æ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞
