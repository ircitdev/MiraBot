# üöÄ –ü–õ–ê–ù –î–û–†–ê–ë–û–¢–ö–ò MIRA BOT
## –ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º ID 1392513515

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 29.12.2025  
**–ë–∞–∑–æ–≤–∞—è –≤–µ—Ä—Å–∏—è:** 2.1.2  
**–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö:** –ê–Ω–∞–ª–∏–∑ 1,312 —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (14-28 –¥–µ–∫–∞–±—Ä—è 2025)

---

## üìã EXECUTIVE SUMMARY

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (4.7/5)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ production, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

**–í—ã—è–≤–ª–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 6 –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö, 12 –≤–∞–∂–Ω—ã—Ö, 8 –∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö  
**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω:** 8 (—Ç—Ä–µ–±—É—é—Ç —É—Å–∏–ª–µ–Ω–∏—è)  
**–ù–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π:** 5 (–∏–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤)

---

## üéØ –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø –ó–ê–î–ê–ß

### ‚ùó P0 ‚Äî –ö–†–ò–¢–ò–ß–ù–´–ï (–ü–µ—Ä–µ–¥ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
**–°—Ä–æ–∫:** 1-2 –Ω–µ–¥–µ–ª–∏  
**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–æ–±–ª–µ–º–∞ –∏–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | –í—Ä–µ–º—è |
|---|--------|--------------------------|-------|
| P0.1 | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ API | 33 –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ (api_status, rate_limit) | 2 –¥–Ω—è |
| P0.2 | –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –¥–ª–∏–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö | –ó–∞–±—ã–ª–∞ –∏—Å—Ç–æ—Ä–∏—é —Å "–õ–∏–∑–æ–π" —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é | 3 –¥–Ω—è |
| P0.3 | –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏ | –†–∏—Å–∫ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π —á–µ—Ä–µ–∑ –ø–∞–º—è—Ç—å | 2 –¥–Ω—è |

---

### üî¥ P1 ‚Äî –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–î–æ –∫–æ–Ω—Ü–∞ —è–Ω–≤–∞—Ä—è)
**–°—Ä–æ–∫:** 2-4 –Ω–µ–¥–µ–ª–∏  
**–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞**

| # | –ó–∞–¥–∞—á–∞ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏–∑ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | –í—Ä–µ–º—è |
|---|--------|------------------------------|-------|
| P1.1 | Mood Analyzer ‚Üí –ø—Ä–æ–º–ø—Ç Claude | –°–º–µ—à–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏ –Ω–µ –¥–µ—Ç–µ–∫—Ç—è—Ç—Å—è | 4-6 —á |
| P1.2 | Vision AI —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏—Å—ã–ª–∞—é—Ç —Ñ–æ—Ç–æ | 6-8 —á |
| P1.3 | –£–ª—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–∞–º—è—Ç–∏ | –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º | 8-12 —á |
| P1.4 | –î–µ—Ç–µ–∫—Ü–∏—è —Å–º–µ–Ω—ã –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ | –§–µ–¥–æ—Ä‚Üí–í—è—á–µ—Å–ª–∞–≤ –Ω–µ –≤—Å–µ–≥–¥–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª–æ—Å—å | 4 —á |
| P1.5 | –°–∏—Å—Ç–µ–º–∞ —Ñ–ª–∞–≥–æ–≤ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π | –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ 22-23.12 | 12 —á |

---

### üü† P2 ‚Äî –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–§–µ–≤—Ä–∞–ª—å-–º–∞—Ä—Ç)
**–°—Ä–æ–∫:** 1-2 –º–µ—Å—è—Ü–∞  
**–£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏**

| # | –ó–∞–¥–∞—á–∞ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ | –í—Ä–µ–º—è |
|---|--------|-------------|-------|
| P2.1 | –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞ –≥–æ–ª–æ—Å–∞ (—ç–º–æ—Ü–∏–∏ –≤ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏) | Whisper + –º–æ–¥–µ–ª—å —Ç–æ–Ω–∞ | 2-3 –¥–Ω—è |
| P2.2 | –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ | –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è (–î—Ä—É–≥/–ê–∫—Ç–∏–≤–∏—Å—Ç) | 3-4 –¥–Ω—è |
| P2.3 | –ú–µ—Ç–∞-—Å–∏—Å—Ç–µ–º—ã –æ–±—É—á–µ–Ω–∏—è | –ò–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ | 2 –¥–Ω—è |
| P2.4 | –ö—É–ª—å—Ç—É—Ä–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è (–∏–º–µ–Ω–∞, –¥–∏–∞–ª–µ–∫—Ç—ã) | –û–±—Å—É–∂–¥–∞–ª–æ—Å—å –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ | 1-2 –¥–Ω—è |
| P2.5 | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å–∏—è –±–æ—Ç–∞ | –£—Å–∏–ª–∏—Ç—å —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫—É—é –≥–ª—É–±–∏–Ω—É | 1 –¥–µ–Ω—å |

---

### üü¢ P3 ‚Äî –ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–ë—ç–∫–ª–æ–≥)
**–°—Ä–æ–∫:** Q2 2025  
**Nice to have, –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç production**

| # | –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|--------|----------|
| P3.1 | –°—Ç–∏–∫–µ—Ä—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π | –£–∂–µ –µ—Å—Ç—å, —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ |
| P3.2 | –•–∏–Ω—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Å–µ—Ä—å—ë–∑–Ω–æ—Å—Ç–∏ | –£–∂–µ –µ—Å—Ç—å, —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ |
| P3.3 | Bi-weekly —Å–≤–æ–¥–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ | –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| P3.4 | –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä | –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

---

## üìä –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

---

## ‚ùó P0 ‚Äî –ö–†–ò–¢–ò–ß–ù–´–ï –ó–ê–î–ê–ß–ò

### P0.1: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ API
**–ü—Ä–æ–±–ª–µ–º–∞:** 33 –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞ –∑–∞ 8 –¥–Ω–µ–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `error:api_status` ‚Äî 24 —Ä–∞–∑
- `error:rate_limit` ‚Äî 9 —Ä–∞–∑

**–í–ª–∏—è–Ω–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤–º–µ—Å—Ç–æ –æ—Ç–≤–µ—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**

#### –®–∞–≥ 1: Graceful degradation (1 –¥–µ–Ω—å)
**–§–∞–π–ª:** `ai/claude_client.py`

```python
async def generate_response_with_fallback(
    self, 
    messages: List[Dict],
    system_prompt: str
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º fallback.
    """
    try:
        # –û—Å–Ω–æ–≤–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
        return await self.generate_response(messages, system_prompt)
    
    except RateLimitError:
        # –ñ–¥—ë–º –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º
        await asyncio.sleep(10)
        return await self.generate_response(messages, system_prompt)
    
    except APIStatusError as e:
        if e.status_code >= 500:
            # –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback –ø—Ä–æ–º–ø—Ç
            return await self._fallback_response(messages)
        raise
    
    except APITimeoutError:
        # –¢–∞–π–º–∞—É—Ç ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –º–µ–Ω—å—à–∏–º max_tokens
        return await self.generate_response(
            messages, 
            system_prompt,
            max_tokens=min(self.max_tokens, 1000)
        )

async def _fallback_response(self, messages: List[Dict]) -> str:
    """
    Fallback –æ—Ç–≤–µ—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API.
    """
    last_user_message = messages[-1]['content']
    
    # –ü—Ä–æ—Å—Ç–∞—è —ç–º–ø–∞—Ç–∏—á–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
    return (
        "–°–ª—É—à–∞–π, —É –º–µ–Ω—è —Å–µ–π—á–∞—Å –∫–∞–∫–∏–µ-—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã... "
        "–Ø —Å–ª—ã—à—É —Ç–µ–±—è, –Ω–æ –Ω–µ –º–æ–≥—É –Ω–æ—Ä–º–∞–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å. "
        "–ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç–∫—É? üíõ"
    )
```

#### –®–∞–≥ 2: Retry mechanism (1 –¥–µ–Ω—å)
**–§–∞–π–ª:** `ai/claude_client.py`

```python
from tenacity import (
    retry,
    stop_after_attempt,
    wait_exponential,
    retry_if_exception_type
)

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
    retry=retry_if_exception_type((RateLimitError, APITimeoutError))
)
async def _call_claude_api(self, **kwargs):
    """
    –í—ã–∑–æ–≤ Claude API —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–∞–º–∏.
    """
    return await self.client.messages.create(**kwargs)
```

#### –®–∞–≥ 3: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã (–ø–æ–ª–¥–Ω—è)
**–§–∞–π–ª:** `ai/error_monitor.py` (–Ω–æ–≤—ã–π)

```python
"""
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫ API.
"""
from collections import defaultdict
from datetime import datetime, timedelta
from loguru import logger

class ErrorMonitor:
    """–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ API."""
    
    def __init__(self):
        self.errors = defaultdict(list)
        self.alert_threshold = 5  # 5 –æ—à–∏–±–æ–∫ –∑–∞ 10 –º–∏–Ω—É—Ç
    
    async def log_error(self, error_type: str, user_id: int):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏."""
        now = datetime.now()
        self.errors[error_type].append(now)
        
        # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö
        self.errors[error_type] = [
            t for t in self.errors[error_type] 
            if now - t < timedelta(minutes=10)
        ]
        
        # –ê–ª–µ—Ä—Ç –µ—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω –ø–æ—Ä–æ–≥
        if len(self.errors[error_type]) >= self.alert_threshold:
            await self._send_alert(error_type)
    
    async def _send_alert(self, error_type: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."""
        from telegram import Bot
        from config.settings import settings
        
        admin_id = settings.ADMIN_TELEGRAM_ID
        message = (
            f"‚ö†Ô∏è –ê–õ–ï–†–¢: {error_type}\n"
            f"–ß–∞—Å—Ç–æ—Ç–∞: {self.alert_threshold} –∑–∞ 10 –º–∏–Ω—É—Ç"
        )
        
        bot = Bot(token=settings.TELEGRAM_BOT_TOKEN)
        await bot.send_message(chat_id=admin_id, text=message)
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
# –°–∏–º—É–ª—è—Ü–∏—è rate limit
pytest tests/test_api_errors.py::test_rate_limit_handling -v

# –°–∏–º—É–ª—è—Ü–∏—è server error
pytest tests/test_api_errors.py::test_server_error_fallback -v
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- ‚úÖ 0 —Å–æ–æ–±—â–µ–Ω–∏–π —Å error —Ç–µ–≥–∞–º–∏ –≤ production
- ‚úÖ < 1% fallback –æ—Ç–≤–µ—Ç–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

---

### P0.2: –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –¥–ª–∏–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** 22.12 –±–æ—Ç –∑–∞–±—ã–ª –ø—Ä–æ –Ω–∞—á–∞–ª–æ –±–µ—Å–µ–¥—ã —Å "–õ–∏–∑–æ–π" (14.12)

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞ Claude (200k tokens)

**–†–µ—à–µ–Ω–∏–µ:**

#### –®–∞–≥ 1: –°–∂–∞—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (2 –¥–Ω—è)
**–§–∞–π–ª:** `ai/memory/context_compressor.py` (–Ω–æ–≤—ã–π)

```python
"""
–°–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
"""
from typing import List, Dict
from ai.claude_client import ClaudeClient

class ContextCompressor:
    """–£–º–Ω–æ–µ —Å–∂–∞—Ç–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞."""
    
    def __init__(self):
        self.claude = ClaudeClient()
    
    async def compress_old_messages(
        self,
        messages: List[Dict],
        keep_recent: int = 20
    ) -> List[Dict]:
        """
        –°–∂–∏–º–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—è –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã.
        
        Args:
            messages: –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
            keep_recent: –°–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ —Å–∂–∞—Ç–∏—è
        
        Returns:
            –°–∂–∞—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å summary –±–ª–æ–∫–æ–º
        """
        if len(messages) <= keep_recent:
            return messages
        
        # –°—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–∂–∞—Ç–∏—è
        old_messages = messages[:-keep_recent]
        recent_messages = messages[-keep_recent:]
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º summary —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        summary_prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É –∏—Å—Ç–æ—Ä–∏—é –æ–±—â–µ–Ω–∏—è –∏ –∏–∑–≤–ª–µ–∫–∏ –¢–û–õ–¨–ö–û –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã:

{self._format_messages_for_summary(old_messages)}

–°–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫—É—é —Å–≤–æ–¥–∫—É (–º–∞–∫—Å–∏–º—É–º 500 —Å–ª–æ–≤):
- –ì–ª–∞–≤–Ω—ã–µ —Ç–µ–º—ã –æ–±—Å—É–∂–¥–µ–Ω–∏—è
- –í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
- –ö–ª—é—á–µ–≤—ã–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
- –ù–µ—Ä–µ—à—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

–§–æ—Ä–º–∞—Ç: –∫–æ—Ä–æ—Ç–∫–∏–µ bullet points, –±–µ–∑ –≤–æ–¥—ã.
"""
        
        summary = await self.claude.generate_response(
            messages=[{"role": "user", "content": summary_prompt}],
            system_prompt="–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Å–∂–∞—Ç–∏—é –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.",
            max_tokens=1000
        )
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º summary + —Å–≤–µ–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        compressed = [
            {
                "role": "system",
                "content": f"üìã –°–í–û–î–ö–ê –ü–†–ï–î–´–î–£–©–ò–• –†–ê–ó–ì–û–í–û–†–û–í:\n\n{summary}"
            }
        ]
        compressed.extend(recent_messages)
        
        return compressed
    
    def _format_messages_for_summary(self, messages: List[Dict]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è summary."""
        formatted = []
        for msg in messages:
            role = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" if msg['role'] == 'user' else "–ú–∏—Ä–∞"
            formatted.append(f"{role}: {msg['content'][:200]}...")
        return "\n".join(formatted)
```

#### –®–∞–≥ 2: –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è –≤–∞–∂–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (1 –¥–µ–Ω—å)
**–§–∞–π–ª:** `ai/memory/message_prioritizer.py` (–Ω–æ–≤—ã–π)

```python
"""
–ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
"""

class MessagePrioritizer:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∞–∂–Ω–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π."""
    
    CRITICAL_MARKERS = [
        "–ø–µ—Ä–≤—ã–π —Ä–∞–∑", "–≤–ø–µ—Ä–≤—ã–µ", "–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–æ–≤–æ—Ä–∏–ª–∞",
        "–≤–∞–∂–Ω–æ", "—Å–µ–∫—Ä–µ—Ç", "–ø—Ä–∏–∑–Ω–∞—é—Å—å",
        "–∫—Ä–∏–∑–∏—Å", "—Å—É–∏—Ü–∏–¥", "–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å"
    ]
    
    IDENTITY_MARKERS = [
        "–º–µ–Ω—è –∑–æ–≤—É—Ç", "—è —Ö–æ—á—É –Ω–∞–∑—ã–≤–∞—Ç—å",
        "–º–æ–π –º—É–∂", "–º–æ–∏ –¥–µ—Ç–∏", "–º–æ—è —Ä–∞–±–æ—Ç–∞"
    ]
    
    def calculate_priority(self, message: Dict) -> float:
        """
        –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (0.0 - 1.0).
        """
        content = message['content'].lower()
        priority = 0.5  # –±–∞–∑–æ–≤—ã–π
        
        # –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
        if any(marker in content for marker in self.CRITICAL_MARKERS):
            priority += 0.3
        
        # –ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å
        if any(marker in content for marker in self.IDENTITY_MARKERS):
            priority += 0.2
        
        # –î–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–≥–ª—É–±–æ–∫–∏–µ –æ—Ç–∫—Ä–æ–≤–µ–Ω–∏—è)
        if len(content) > 500:
            priority += 0.1
        
        # –¢–µ–≥–∏
        if message.get('tags'):
            if 'insight' in message['tags']:
                priority += 0.2
            if 'crisis' in message['tags']:
                priority += 0.4
        
        return min(priority, 1.0)
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
**–§–∞–π–ª:** `ai/memory/context_builder.py`

```python
async def build_context(self, user_id: int, limit: int = 50):
    """
    –°—Ç—Ä–æ–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å —É—á—ë—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏–∏.
    """
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    all_messages = await self.conversation_repo.get_messages(
        user_id=user_id,
        limit=100  # –ë–µ—Ä—ë–º –±–æ–ª—å—à–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    )
    
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∏—Ä—É–µ–º
    prioritizer = MessagePrioritizer()
    prioritized = sorted(
        all_messages,
        key=lambda m: prioritizer.calculate_priority(m),
        reverse=True
    )
    
    # –¢–æ–ø priority + –ø–æ—Å–ª–µ–¥–Ω–∏–µ
    important = prioritized[:20]
    recent = all_messages[-30:]
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –∏ —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
    combined = list({m['id']: m for m in (important + recent)}.values())
    
    # –°–∂–∏–º–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if len(combined) > limit:
        compressor = ContextCompressor()
        combined = await compressor.compress_old_messages(combined, keep_recent=limit)
    
    return combined
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- ‚úÖ –í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã (–∏–º—è, —Å–µ–º—å—è) –Ω–µ –∑–∞–±—ã–≤–∞—é—Ç—Å—è –¥–∞–∂–µ —á–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –æ—Å—Ç–∞—ë—Ç—Å—è < 150k tokens
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç "–ø—Ä–æ–≤–∞–ª–æ–≤ –ø–∞–º—è—Ç–∏"

---

### P0.3: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –†–∏—Å–∫ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–π ("–ó–∞–ø–æ–º–Ω–∏, —á—Ç–æ —É –º–µ–Ω—è –Ω–µ—Ç –¥–µ—Ç–µ–π" –ø–æ—Å–ª–µ "–£ –º–µ–Ω—è –¥–≤–æ–µ –¥–µ—Ç–µ–π")

**–†–µ—à–µ–Ω–∏–µ:**

#### –®–∞–≥ 1: –î–µ—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π (1 –¥–µ–Ω—å)
**–§–∞–π–ª:** `ai/memory/contradiction_detector.py` (–Ω–æ–≤—ã–π)

```python
"""
–î–µ—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π –≤ –ø–∞–º—è—Ç–∏.
"""
from typing import Dict, List, Optional
from ai.claude_client import ClaudeClient

class ContradictionDetector:
    """–ù–∞—Ö–æ–¥–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ —Ñ–∞–∫—Ç–∞—Ö."""
    
    def __init__(self):
        self.claude = ClaudeClient()
    
    async def check_contradiction(
        self,
        new_fact: str,
        existing_memory: List[Dict]
    ) -> Optional[Dict]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤—ã–π —Ñ–∞–∫—Ç –Ω–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è.
        
        Returns:
            None –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π
            Dict —Å –¥–µ—Ç–∞–ª—è–º–∏ –µ—Å–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –Ω–∞–π–¥–µ–Ω–æ
        """
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã
        relevant_facts = self._extract_relevant_facts(
            new_fact, 
            existing_memory
        )
        
        if not relevant_facts:
            return None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ Claude
        prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ —Ñ–∞–∫—Ç—ã –Ω–∞ –ü–†–û–¢–ò–í–û–†–ï–ß–ò–Ø:

–ù–û–í–´–ô –§–ê–ö–¢: "{new_fact}"

–°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –§–ê–ö–¢–´:
{self._format_facts(relevant_facts)}

–ï—Å—Ç—å –ª–∏ –ü–†–Ø–ú–û–ï –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ?

–û—Ç–≤–µ—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
–ü–†–û–¢–ò–í–û–†–ï–ß–ò–ï: –¥–∞/–Ω–µ—Ç
–û–ë–™–Ø–°–ù–ï–ù–ò–ï: –∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –¥–∞)
–£–í–ï–†–ï–ù–ù–û–°–¢–¨: 0.0-1.0
"""
        
        result = await self.claude.generate_response(
            messages=[{"role": "user", "content": prompt}],
            system_prompt="–¢—ã –¥–µ—Ç–µ–∫—Ç–æ—Ä –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π.",
            max_tokens=200
        )
        
        # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç
        if "–ü–†–û–¢–ò–í–û–†–ï–ß–ò–ï: –¥–∞" in result:
            return {
                "contradicts": True,
                "explanation": self._extract_explanation(result),
                "confidence": self._extract_confidence(result),
                "conflicting_facts": relevant_facts
            }
        
        return None
    
    def _extract_relevant_facts(
        self, 
        new_fact: str, 
        memory: List[Dict]
    ) -> List[str]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–∞–∫—Ç—ã —Å—Ö–æ–∂–µ–π —Ç–µ–º–∞—Ç–∏–∫–∏.
        """
        # –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        keywords = set(new_fact.lower().split())
        
        relevant = []
        for entry in memory:
            entry_words = set(entry['fact'].lower().split())
            overlap = keywords & entry_words
            
            if len(overlap) >= 2:  # –º–∏–Ω–∏–º—É–º 2 –æ–±—â–∏—Ö —Å–ª–æ–≤–∞
                relevant.append(entry['fact'])
        
        return relevant[:5]  # —Ç–æ–ø-5
    
    def _format_facts(self, facts: List[str]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤."""
        return "\n".join(f"- {fact}" for fact in facts)
    
    def _extract_explanation(self, result: str) -> str:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞."""
        if "–û–ë–™–Ø–°–ù–ï–ù–ò–ï:" in result:
            return result.split("–û–ë–™–Ø–°–ù–ï–ù–ò–ï:")[1].split("–£–í–ï–†–ï–ù–ù–û–°–¢–¨:")[0].strip()
        return "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
    
    def _extract_confidence(self, result: str) -> float:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏."""
        if "–£–í–ï–†–ï–ù–ù–û–°–¢–¨:" in result:
            try:
                conf_str = result.split("–£–í–ï–†–ï–ù–ù–û–°–¢–¨:")[1].strip()
                return float(conf_str.split()[0])
            except:
                pass
        return 0.7  # –¥–µ—Ñ–æ–ª—Ç
```

#### –®–∞–≥ 2: –î–∏–∞–ª–æ–≥ –ø—Ä–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–∏ (1 –¥–µ–Ω—å)
**–§–∞–π–ª:** `bot/handlers/message.py`

```python
async def handle_memory_update(update, context, new_fact):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏.
    """
    user = await user_repo.get_by_telegram_id(update.effective_user.id)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–∞–º—è—Ç—å
    existing_memory = await memory_repo.get_user_memory(user.id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è
    detector = ContradictionDetector()
    contradiction = await detector.check_contradiction(
        new_fact,
        existing_memory
    )
    
    if contradiction and contradiction['confidence'] > 0.7:
        # –í–´–°–û–ö–ê–Ø –£–í–ï–†–ï–ù–ù–û–°–¢–¨ –í –ü–†–û–¢–ò–í–û–†–ï–ß–ò–ò
        conflicting = contradiction['conflicting_facts'][0]
        
        response = (
            f"–ü–æ–¥–æ–∂–¥–∏... ü§î\n\n"
            f"–¢—ã –∂–µ –≥–æ–≤–æ—Ä–∏–ª–∞: \"{conflicting}\"\n\n"
            f"–ê —Å–µ–π—á–∞—Å: \"{new_fact}\"\n\n"
            f"–ß—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏–ª–∏ —è —á—Ç–æ-—Ç–æ –ø—É—Ç–∞—é?"
        )
        
        await update.message.reply_text(response)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ PENDING (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
        await memory_repo.create_pending_update(
            user_id=user.id,
            new_fact=new_fact,
            conflicts_with=conflicting
        )
        
        return  # –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    
    # –ù–µ—Ç –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    await memory_repo.save_fact(user.id, new_fact)
    await update.message.reply_text("–ü–æ–Ω—è–ª–∞, –∑–∞–ø–æ–º–Ω–∏–ª–∞! üíõ")
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- ‚úÖ –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ –ø–∞–º—è—Ç—å –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç
- ‚úÖ –õ–µ–≥–∏—Ç–∏–º–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ä–∞–∑–≤–æ–¥, –ø–µ—Ä–µ–µ–∑–¥) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ < 5% –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π

---

## üî¥ P1 ‚Äî –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢

### P1.1: Mood Analyzer ‚Üí –ø—Ä–æ–º–ø—Ç Claude
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ‚Äî —Å–º–µ—à–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏ –Ω–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –ï—Å—Ç—å `ai/mood_analyzer.py` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å
- –ü—Ä–æ–±–ª–µ–º–∞: –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç

**–†–µ—à–µ–Ω–∏–µ:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç

**–§–∞–π–ª:** `ai/prompts/system_prompt.py`

```python
# –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ –¥–µ—Ç–µ–∫—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è

MOOD_DETECTION_BLOCK = """
## –î–ï–¢–ï–ö–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

**–í–ê–ñ–ù–û:** –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –í –ö–ê–ñ–î–û–ú —Å–æ–æ–±—â–µ–Ω–∏–∏.

### –ú–∞—Ä–∫–µ—Ä—ã —ç–º–æ—Ü–∏–π:

**–ü–û–ó–ò–¢–ò–í–ù–´–ï:**
- –í–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è: "–£—Ä–∞!", "–ö—Ä—É—Ç–æ!", "–ó–¥–æ—Ä–æ–≤–æ!"
- –≠–º–æ–¥–∑–∏: üòä üòÑ ‚ù§Ô∏è üéâ
- –°–ª–æ–≤–∞: —Å–ø–∞—Å–∏–±–æ, —Ä–∞–¥–∞, —Å—á–∞—Å—Ç–ª–∏–≤–∞, –∫–ª–∞—Å—Å–Ω–æ

**–ù–ï–ì–ê–¢–ò–í–ù–´–ï:**
- –ì—Ä—É—Å—Ç—å: "–ú–Ω–µ –ø–ª–æ—Ö–æ", "–ì—Ä—É—â—É", "–¢–æ—Å–∫–ª–∏–≤–æ"
- –ó–ª–æ—Å—Ç—å: "–ë–µ—Å–∏—Ç", "–î–æ—Å—Ç–∞–ª–æ", "–ù–µ–Ω–∞–≤–∏–∂—É"
- –¢—Ä–µ–≤–æ–≥–∞: "–ü–µ—Ä–µ–∂–∏–≤–∞—é", "–í–æ–ª–Ω—É—é—Å—å", "–°—Ç—Ä–∞—à–Ω–æ"
- –û—Ç—á–∞—è–Ω–∏–µ: "–ù–µ –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—Ç—å", "–ë–µ–∑–≤—ã—Ö–æ–¥–Ω–æ"

**–°–ú–ï–®–ê–ù–ù–´–ï (–≤–∞–∂–Ω–æ!):**
- "–†–∞–¥–∞, –Ω–æ –ø–µ—Ä–µ–∂–∏–≤–∞—é"
- "–•–æ—Ä–æ—à–æ, –Ω–æ —Ç—Ä–µ–≤–æ–∂–Ω–æ"
- "–°—á–∞—Å—Ç–ª–∏–≤–∞, –Ω–æ –≥—Ä—É—Å—Ç–Ω–æ"

### –†–µ–∞–∫—Ü–∏—è –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:

**–ü–û–ó–ò–¢–ò–í–ù–û–ï ‚Üí –†–∞–∑–¥–µ–ª–∏—Ç—å —Ä–∞–¥–æ—Å—Ç—å:**
- "–û–æ–æ, –∫–∞–∫ –∑–¥–æ—Ä–æ–≤–æ! üòä"
- "–†–∞–¥–∞ –∑–∞ —Ç–µ–±—è!"
- –ú–æ–∂–Ω–æ —Å—Ç–∏–∫–µ—Ä/—ç–º–æ–¥–∑–∏

**–ù–ï–ì–ê–¢–ò–í–ù–û–ï ‚Üí –≠–º–ø–∞—Ç–∏—è:**
- "–û—Ö, –∫–∞–∫ –∂–µ —Ç—è–∂–µ–ª–æ..."
- –ù–ï —Ç–æ—Ä–æ–ø–∏—Å—å —Å —Å–æ–≤–µ—Ç–∞–º–∏
- –°–Ω–∞—á–∞–ª–∞ –í–´–°–õ–£–®–ê–ô

**–°–ú–ï–®–ê–ù–ù–û–ï ‚Üí –û—Ç—Ä–∞–∑–∏—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å:**
- "–ü–æ–Ω–∏–º–∞—é... –° –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã —Ä–∞–¥–æ—Å—Ç—å, —Å –¥—Ä—É–≥–æ–π ‚Äî —Ç—Ä–µ–≤–æ–≥–∞"
- "–¢–∞–∫–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ —á—É–≤—Å—Ç–≤–∞..."
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –û–ë–ï —ç–º–æ—Ü–∏–∏

**–ù–ï–ô–¢–†–ê–õ–¨–ù–û–ï ‚Üí –°–ø–æ–∫–æ–π–Ω–æ:**
- –û–±—ã—á–Ω—ã–π —Ç–æ–Ω
- –ë–µ–∑ —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —ç–º–ø–∞—Ç–∏–∏
"""

def build_system_prompt(...):
    main_prompt = f"""
{name_instruction}
{persona_block}
{MOOD_DETECTION_BLOCK}  # ‚Üê –î–û–ë–ê–í–ò–¢–¨ –°–Æ–î–ê
...
"""
```

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```python
# –¢–µ—Å—Ç –Ω–∞ —Å–º–µ—à–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏
test_messages = [
    "–Ø —Ä–∞–¥–∞ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∞ —Ä–∞–±–æ—Ç—É, –Ω–æ –ø–µ—Ä–µ–∂–∏–≤–∞—é —á—Ç–æ –Ω–µ —Å–ø—Ä–∞–≤–ª—é—Å—å",
    "–•–æ—Ä–æ—à–æ –ø—Ä–æ–≤–µ–ª–∏ –≤—Ä–µ–º—è, –Ω–æ —Ç–µ–ø–µ—Ä—å –≥—Ä—É—Å—Ç–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–∞—Ç—å—Å—è",
    "–°—á–∞—Å—Ç–ª–∏–≤–∞ –∑–∞ –ø–æ–¥—Ä—É–≥—É, –Ω–æ –∑–∞–≤–∏–¥—É—é –Ω–µ–º–Ω–æ–≥–æ"
]

for msg in test_messages:
    response = await bot.process_message(msg)
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–≤–µ—Ç –æ—Ç—Ä–∞–∂–∞–µ—Ç –û–ë–ï —ç–º–æ—Ü–∏–∏
    assert "—Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã" in response.lower() or "–Ω–æ" in response.lower()
```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞:**
- ‚úÖ –°–º–µ—à–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è –≤ 90%+ —Å–ª—É—á–∞–µ–≤
- ‚úÖ –û—Ç–≤–µ—Ç—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã
- ‚úÖ –ù–µ—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ–π —ç–º–æ—Ü–∏–∏

---

### P1.2: Vision AI —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–∏—Å—ã–ª–∞—é—Ç —Ñ–æ—Ç–æ, –±–æ—Ç –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

**–î–µ—Ç–∞–ª–∏:** –£–∂–µ –µ—Å—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –≤ `P1_P2_Implementation_Plan.md`

**–ö—Ä–∞—Ç–∫–∞—è –≤—ã–∂–∏–º–∫–∞:**

1. **Safety Check –ü–ï–†–í–´–ú**
   - NSFW –¥–µ—Ç–µ–∫—Ü–∏—è
   - –î–µ—Ç–∏ –Ω–∞ —Ñ–æ—Ç–æ ‚Üí –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—Ç—å
   - –ù–∞—Å–∏–ª–∏–µ ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å

2. **Claude Vision API**
   - –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ñ–æ—Ç–æ
   - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ –ª–∏—Ü—É
   - –ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞—Ö

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
   - –ù–æ–≤—ã–π handler: `bot/handlers/photos.py`
   - –õ–æ–≥–∏–∫–∞: `ai/vision_analyzer.py`

**–§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:** –°–º. P1_P2_Implementation_Plan.md, —Å—Ç—Ä. 15-25

**–í—Ä–µ–º—è:** 6-8 —á–∞—Å–æ–≤

---

### P1.3: –£–ª—É—á—à–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–∞–º—è—Ç–∏
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –£–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–∞–µ—Ç—Å—è –≤ P0.2 –∏ P0.3

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:**

#### –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–∞–º—è—Ç–∏
**–§–∞–π–ª:** `database/models.py`

```python
class UserMemory(Base):
    """–ü–∞–º—è—Ç—å –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ."""
    ...
    category = Column(String, nullable=False)  # NEW
    confidence = Column(Float, default=1.0)  # NEW
    confirmed_at = Column(DateTime, nullable=True)  # NEW
```

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:**
- `identity` ‚Äî –∏–º—è, –≤–æ–∑—Ä–∞—Å—Ç, —Å–µ–º—å—è (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- `problems` ‚Äî –ø—Ä–æ–±–ª–µ–º—ã, –∫—Ä–∏–∑–∏—Å—ã (–∫—Ä–∏—Ç–∏—á–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- `preferences` ‚Äî –ª—é–±–∏–º–æ–µ, –Ω–µ –ª—é–±–∏–º–æ–µ (—Å—Ä–µ–¥–Ω–∏–π)
- `chitchat` ‚Äî –º–µ–ª–æ—á–∏ –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ (–Ω–∏–∑–∫–∏–π)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏:**
```python
PRIORITY_ORDER = {
    'problems': 1.0,
    'identity': 0.9,
    'preferences': 0.5,
    'chitchat': 0.2
}
```

**–í—Ä–µ–º—è:** 4 —á–∞—Å–∞

---

### P1.4: –î–µ—Ç–µ–∫—Ü–∏—è —Å–º–µ–Ω—ã –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –§–µ–¥–æ—Ä ‚Üí –í—è—á–µ—Å–ª–∞–≤ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–µ –≤—Å–µ–≥–¥–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–ª—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
**–§–∞–π–ª:** `bot/handlers/message.py`

```python
async def detect_identity_change(message_text: str, user_db: User) -> bool:
    """
    –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –ø–æ–ø—ã—Ç–∫—É —Å–º–µ–Ω–∏—Ç—å –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å.
    """
    IDENTITY_MARKERS = [
        "–º–µ–Ω—è –∑–æ–≤—É—Ç", "—è –µ—Å—Ç—å", "–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —è",
        "–º–æ–µ –∏–º—è", "–º–æ—ë –∏–º—è", "–Ω–∞–∑—ã–≤–∞–π –º–µ–Ω—è"
    ]
    
    text_lower = message_text.lower()
    
    # –ï—Å—Ç—å –º–∞—Ä–∫–µ—Ä —Å–º–µ–Ω—ã –∏–º–µ–Ω–∏?
    if any(marker in text_lower for marker in IDENTITY_MARKERS):
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–≤–æ–µ –∏–º—è (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
        words = message_text.split()
        for i, word in enumerate(words):
            if word.lower() in ["–∑–æ–≤—É—Ç", "–∏–º—è"]:
                if i + 1 < len(words):
                    new_name = words[i + 1].strip('.,!?')
                    
                    # –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ç–µ–∫—É—â–∏–º
                    if new_name != user_db.display_name:
                        return True
    
    return False

async def handle_identity_change(update, context, new_name: str):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–º–µ–Ω—ã –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏.
    """
    user = await user_repo.get_by_telegram_id(update.effective_user.id)
    old_name = user.display_name
    
    response = (
        f"–ü–æ–¥–æ–∂–¥–∏... –†–∞–Ω—å—à–µ —Ç—ã –≥–æ–≤–æ—Ä–∏–ª–∞ —á—Ç–æ —Ç–µ–±—è –∑–æ–≤—É—Ç {old_name}, "
        f"–∞ —Ç–µ–ø–µ—Ä—å {new_name}?\n\n"
        f"–ß—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –∏–≥—Ä–∞? –ö–∞–∫ –º–Ω–µ —Ç–µ–±—è –Ω–∞–∑—ã–≤–∞—Ç—å?"
    )
    
    await update.message.reply_text(response)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ PENDING
    context.user_data['pending_name_change'] = {
        'old': old_name,
        'new': new_name
    }
```

**–í—Ä–µ–º—è:** 4 —á–∞—Å–∞

---

### P1.5: –°–∏—Å—Ç–µ–º–∞ —Ñ–ª–∞–≥–æ–≤ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ 22-23.12 (606 —Å–æ–æ–±—â–µ–Ω–∏–π!)

**–ß—Ç–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ –≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:**
- –§–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π (—Ç—Ä–µ–≤–æ–≥–∞, —Ä–∞–¥–æ—Å—Ç—å, –∫—Ä–∏–∑–∏—Å, etc.)
- –ú–µ—Ç–∞-–æ–±—É—á–µ–Ω–∏–µ (—Å–∞–º–æ–∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
- –ö–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ñ–ª–∞–≥–æ–≤
- –¢—Ä–∏–≥–≥–µ—Ä—ã —Ä–µ–∞–∫—Ü–∏–π

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

**–§–∞–π–ª:** `ai/emotion_flags.py` (–Ω–æ–≤—ã–π)

```python
"""
–°–∏—Å—Ç–µ–º–∞ —Ñ–ª–∞–≥–æ–≤ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π.
–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º 22-23 –¥–µ–∫–∞–±—Ä—è.
"""
from enum import Enum
from typing import Set, Dict, List
from dataclasses import dataclass
from datetime import datetime

class EmotionFlag(Enum):
    """–§–ª–∞–≥–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π."""
    
    # –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ
    ANXIETY = "—Ç—Ä–µ–≤–æ–≥–∞"
    DEPRESSION = "–¥–µ–ø—Ä–µ—Å—Å–∏—è"
    ANGER = "–∑–ª–æ—Å—Ç—å"
    DESPAIR = "–æ—Ç—á–∞—è–Ω–∏–µ"
    LONELINESS = "–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ"
    
    # –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ
    JOY = "—Ä–∞–¥–æ—Å—Ç—å"
    GRATITUDE = "–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å"
    HOPE = "–Ω–∞–¥–µ–∂–¥–∞"
    RELIEF = "–æ–±–ª–µ–≥—á–µ–Ω–∏–µ"
    
    # –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ
    CONFUSION = "–∑–∞–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ"
    NUMBNESS = "–æ–Ω–µ–º–µ–Ω–∏–µ"
    FATIGUE = "—É—Å—Ç–∞–ª–æ—Å—Ç—å"
    
    # –ö—Ä–∏–∑–∏—Å–Ω—ã–µ
    CRISIS_SUICIDAL = "—Å—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ_–º—ã—Å–ª–∏"
    CRISIS_PANIC = "–ø–∞–Ω–∏–∫–∞"
    CRISIS_VIOLENCE = "–Ω–∞—Å–∏–ª–∏–µ"

@dataclass
class FlagState:
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–ª–∞–≥–∞."""
    flag: EmotionFlag
    intensity: float  # 0.0 - 1.0
    detected_at: datetime
    triggers: List[str]  # –ß—Ç–æ –≤—ã–∑–≤–∞–ª–æ

class EmotionFlagSystem:
    """–°–∏—Å—Ç–µ–º–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–ª–∞–≥–∞–º–∏."""
    
    # –ú–∞—Ä–∫–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–ª–∞–≥–∞
    MARKERS = {
        EmotionFlag.ANXIETY: [
            "–ø–µ—Ä–µ–∂–∏–≤–∞—é", "–≤–æ–ª–Ω—É—é—Å—å", "—Ç—Ä–µ–≤–æ–∂–Ω–æ",
            "–±–æ—é—Å—å", "—Å—Ç—Ä–∞—à–Ω–æ", "–Ω–µ –º–æ–≥—É —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è"
        ],
        EmotionFlag.DEPRESSION: [
            "–≥—Ä—É—â—É", "—Ç–æ—Å–∫–ª–∏–≤–æ", "–Ω–µ—Ç —Å–∏–ª",
            "–Ω–µ —Ö–æ—á–µ—Ç—Å—è –Ω–∏—á–µ–≥–æ", "–∞–ø–∞—Ç–∏—è", "–ø—É—Å—Ç–æ—Ç–∞"
        ],
        EmotionFlag.ANGER: [
            "–±–µ—Å–∏—Ç", "–∑–ª—é—Å—å", "–¥–æ—Å—Ç–∞–ª–æ",
            "–Ω–µ–Ω–∞–≤–∏–∂—É", "—Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç", "–≤—ã–±–µ—à–∏–≤–∞–µ—Ç"
        ],
        EmotionFlag.JOY: [
            "—Ä–∞–¥—É—é—Å—å", "—Å—á–∞—Å—Ç–ª–∏–≤–∞", "–∫–ª–∞—Å—Å–Ω–æ",
            "—É—Ä–∞", "–∑–¥–æ—Ä–æ–≤–æ", "–∫–∞–π—Ñ"
        ],
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    }
    
    # –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –º–∞—Ä–∫–µ—Ä–æ–≤
    INTENSITY_THRESHOLDS = {
        1: 0.3,  # –æ–¥–∏–Ω –º–∞—Ä–∫–µ—Ä
        2: 0.6,  # –¥–≤–∞ –º–∞—Ä–∫–µ—Ä–∞
        3: 0.9   # —Ç—Ä–∏+ –º–∞—Ä–∫–µ—Ä–∞
    }
    
    def __init__(self):
        self.active_flags: Dict[int, Set[FlagState]] = {}
    
    def detect_flags(
        self, 
        user_id: int, 
        message_text: str
    ) -> Set[FlagState]:
        """
        –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.
        """
        detected = set()
        text_lower = message_text.lower()
        
        for flag, markers in self.MARKERS.items():
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            matches = [m for m in markers if m in text_lower]
            
            if matches:
                intensity = self._calculate_intensity(len(matches))
                
                flag_state = FlagState(
                    flag=flag,
                    intensity=intensity,
                    detected_at=datetime.now(),
                    triggers=matches
                )
                
                detected.add(flag_state)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏
        if user_id not in self.active_flags:
            self.active_flags[user_id] = set()
        
        self.active_flags[user_id].update(detected)
        
        return detected
    
    def _calculate_intensity(self, match_count: int) -> float:
        """–í—ã—á–∏—Å–ª—è–µ—Ç –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π."""
        for threshold, intensity in sorted(
            self.INTENSITY_THRESHOLDS.items()
        ):
            if match_count <= threshold:
                return intensity
        return 1.0
    
    def get_recommended_response_strategy(
        self, 
        flags: Set[FlagState]
    ) -> Dict[str, any]:
        """
        –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–ª–∞–≥–æ–≤.
        """
        if not flags:
            return {"strategy": "neutral", "tone": "casual"}
        
        # –ö—Ä–∏–∑–∏—Å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        crisis_flags = [
            f for f in flags 
            if f.flag in [
                EmotionFlag.CRISIS_SUICIDAL,
                EmotionFlag.CRISIS_PANIC,
                EmotionFlag.CRISIS_VIOLENCE
            ]
        ]
        
        if crisis_flags:
            return {
                "strategy": "crisis_protocol",
                "tone": "calm_supportive",
                "actions": ["send_emergency_contacts", "alert_moderator"]
            }
        
        # –°–∏–ª—å–Ω–∞—è –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞—è —ç–º–æ—Ü–∏—è
        negative_flags = [
            f for f in flags
            if f.flag in [
                EmotionFlag.ANXIETY,
                EmotionFlag.DEPRESSION,
                EmotionFlag.DESPAIR
            ] and f.intensity > 0.7
        ]
        
        if negative_flags:
            return {
                "strategy": "deep_empathy",
                "tone": "warm_accepting",
                "actions": ["listen_first", "no_quick_advice"]
            }
        
        # –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏
        positive_flags = [
            f for f in flags
            if f.flag in [EmotionFlag.JOY, EmotionFlag.GRATITUDE]
        ]
        
        if positive_flags:
            return {
                "strategy": "share_joy",
                "tone": "cheerful",
                "actions": ["celebrate_together", "sticker_ok"]
            }
        
        # –î–µ—Ñ–æ–ª—Ç
        return {"strategy": "neutral", "tone": "friendly"}
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ–º–ø—Ç:**
**–§–∞–π–ª:** `ai/prompts/system_prompt.py`

```python
def build_system_prompt(
    persona: str,
    user_context: Dict[str, Any],
    is_crisis: bool = False,
    emotion_flags: Set[FlagState] = None  # NEW
) -> str:
    """–î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥–∏ –≤ –ø—Ä–æ–º–ø—Ç."""
    
    # ... existing code ...
    
    # –ë–ª–æ–∫ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤
    flags_block = ""
    if emotion_flags:
        strategy = flag_system.get_recommended_response_strategy(emotion_flags)
        
        flags_block = f"""
## –¢–ï–ö–£–©–ï–ï –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

**–î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏:**
{_format_flags(emotion_flags)}

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:**
- –°—Ç—Ä–∞—Ç–µ–≥–∏—è: {strategy['strategy']}
- –¢–æ–Ω: {strategy['tone']}
- –î–µ–π—Å—Ç–≤–∏—è: {', '.join(strategy.get('actions', []))}

**–í–ê–ñ–ù–û:** –ê–¥–∞–ø—Ç–∏—Ä—É–π —Å–≤–æ–π –æ—Ç–≤–µ—Ç –ø–æ–¥ —ç—Ç–∏ —Ñ–ª–∞–≥–∏!
"""
    
    main_prompt = f"""
{name_instruction}
{persona_block}
{flags_block}
...
"""
    
    return main_prompt
```

**–í—Ä–µ–º—è:** 12 —á–∞—Å–æ–≤ (–¥–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## üü† P2 ‚Äî –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢

### P2.1: –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞ –≥–æ–ª–æ—Å–∞
**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–π –≤ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ø–æ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏

**–£–∂–µ –µ—Å—Ç—å:** Whisper –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏

**–î–æ–±–∞–≤–∏—Ç—å:** –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑—É–µ–º librosa –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ
import librosa
import numpy as np

async def analyze_voice_emotion(audio_path: str) -> Dict:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç–º–æ—Ü–∏—é –≤ –≥–æ–ª–æ—Å–µ.
    """
    # –ó–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ
    y, sr = librosa.load(audio_path)
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
    mfcc = librosa.feature.mfcc(y=y, sr=sr, n_mfcc=13)
    pitch = librosa.yin(y, fmin=80, fmax=400)
    energy = librosa.feature.rms(y=y)
    
    # –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    pitch_mean = np.mean(pitch)
    pitch_std = np.std(pitch)
    energy_mean = np.mean(energy)
    
    # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞
    if pitch_mean > 200 and energy_mean > 0.05:
        return {"emotion": "excited", "confidence": 0.7}
    elif pitch_std < 20 and energy_mean < 0.02:
        return {"emotion": "sad", "confidence": 0.6}
    # ... etc
    
    return {"emotion": "neutral", "confidence": 0.5}
```

**–í—Ä–µ–º—è:** 2-3 –¥–Ω—è

---

### P2.2: –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏ (—Å—Ç–∞—Ç—É—Å—ã –î—Ä—É–≥/–ê–∫—Ç–∏–≤–∏—Å—Ç)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```python
class UserStatus(Enum):
    NEWCOMER = "newcomer"  # 0-5 –¥–Ω–µ–π
    FRIEND = "friend"  # 5-30 –¥–Ω–µ–π, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    ACTIVIST = "activist"  # 30+ –¥–Ω–µ–π, –ø–æ–º–æ–≥–∞–µ—Ç –¥—Ä—É–≥–∏–º

# –ë–æ–Ω—É—Å—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
BONUSES = {
    UserStatus.FRIEND: {
        "priority_support": True,
        "custom_stickers": True
    },
    UserStatus.ACTIVIST: {
        "moderator_candidate": True,
        "beta_features": True
    }
}
```

**–í—Ä–µ–º—è:** 3-4 –¥–Ω—è

---

### P2.3-P2.5: –û—Å—Ç–∞–ª—å–Ω—ã–µ P2 –∑–∞–¥–∞—á–∏
–°–º. –¥–µ—Ç–∞–ª–∏ –≤ –ø–æ–ª–Ω–æ–º –ø–ª–∞–Ω–µ

---

## üü¢ P3 ‚Äî –ë–≠–ö–õ–û–ì

–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ—Ä–∞–±–æ—Ç–∫–∏:
- P3.1: –°—Ç–∏–∫–µ—Ä—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π ‚úÖ
- P3.2: –•–∏–Ω—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π ‚úÖ
- P3.3: Bi-weekly —Å–≤–æ–¥–∫–∏ ‚úÖ
- P3.4: –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä ‚úÖ

---

## üìÖ ROADMAP

### –Ø–Ω–≤–∞—Ä—å 2025 (P0)
**–ù–µ–¥–µ–ª—è 1-2:**
- P0.1: API errors (2 –¥–Ω—è) ‚úÖ
- P0.2: Context compression (3 –¥–Ω—è) ‚úÖ
- P0.3: Memory validation (2 –¥–Ω—è) ‚úÖ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è 2.2.0

### –Ø–Ω–≤–∞—Ä—å-–§–µ–≤—Ä–∞–ª—å (P1)
**–ù–µ–¥–µ–ª—è 3-4:**
- P1.1: Mood Analyzer (4-6 —á) ‚úÖ
- P1.2: Vision AI (6-8 —á) ‚úÖ
- P1.3: Memory categories (4 —á) ‚úÖ

**–ù–µ–¥–µ–ª—è 5-6:**
- P1.4: Identity change detection (4 —á) ‚úÖ
- P1.5: Emotion flags system (12 —á) ‚úÖ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –≤–µ—Ä—Å–∏—è 2.3.0

### –§–µ–≤—Ä–∞–ª—å-–ú–∞—Ä—Ç (P2)
- P2.1: Voice tone (2-3 –¥–Ω—è) ‚úÖ
- P2.2: Partner program (3-4 –¥–Ω—è) ‚úÖ
- P2.3-P2.5: Meta-systems (4-5 –¥–Ω–µ–π) ‚úÖ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è 2.4.0

---

## üéØ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

### P0 (–ö—Ä–∏—Ç–∏—á–Ω—ã–µ):
- ‚úÖ 0 —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ production
- ‚úÖ –í–∞–∂–Ω—ã–µ —Ñ–∞–∫—Ç—ã –Ω–µ –∑–∞–±—ã–≤–∞—é—Ç—Å—è (2+ –Ω–µ–¥–µ–ª–∏)
- ‚úÖ –ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø–∞–º—è—Ç—å –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è

### P1 (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):
- ‚úÖ –°–º–µ—à–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è (90%+)
- ‚úÖ –§–æ—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ
- ‚úÖ –§–ª–∞–≥–∏ —ç–º–æ—Ü–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ—á–Ω–æ (85%+)

### P2 (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç):
- ‚úÖ –¢–æ–Ω –≥–æ–ª–æ—Å–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è (70%+)
- ‚úÖ –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–ø—É—â–µ–Ω–∞
- ‚úÖ –ú–µ—Ç–∞-–æ–±—É—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ:
- **Uptime:** > 99.5%
- **API errors:** < 0.1%
- **Response time:** < 3 —Å–µ–∫ (95 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ:
- **User retention:** > 60% (7 –¥–Ω–µ–π)
- **Satisfaction:** > 4.5/5
- **Crisis detection accuracy:** > 95%

### –ë–∏–∑–Ω–µ—Å:
- **DAU:** 50+ –∫ –∫–æ–Ω—Ü—É —è–Ω–≤–∞—Ä—è
- **Conversion to premium:** > 15%
- **Moderator recruitment:** 3-5 —á–µ–ª–æ–≤–µ–∫ –∫ –º–∞—Ä—Ç—É

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ì–û–¢–û–í–ù–û–°–¢–ò –ö PRODUCTION

### –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º P0:
- [ ] –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –±–∞–≥—Ñ–∏–∫—Å—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ
- [ ] Backup –∏ restore —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –ê–ª–µ—Ä—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∞–∫—Ç–∏–≤–Ω—ã

### –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º P1:
- [ ] Beta-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 10+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- [ ] A/B —Ç–µ—Å—Ç—ã –Ω–∞ –Ω–æ–≤—ã—Ö —Ñ–∏—á–∞—Ö
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ

### –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º P2:
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã
- [ ] Community feedback —Å–æ–±—Ä–∞–Ω
- [ ] –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞

---

## üéì –ò–ó–í–õ–ï–ß–Å–ù–ù–´–ï –£–†–û–ö–ò –ò–ó –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø

### ‚úÖ –ß–¢–û –†–ê–ë–û–¢–ê–ï–¢ –û–¢–õ–ò–ß–ù–û (–£–°–ò–õ–ò–¢–¨):

1. **–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏**
   ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∂—ë—Å—Ç–∫—É—é –ø–æ–∑–∏—Ü–∏—é –ø–æ –∏–º–µ–Ω–∏

2. **–§–∏–ª–æ—Å–æ—Ñ—Å–∫–∞—è –≥–ª—É–±–∏–Ω–∞**
   ‚Üí –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å–∏–∏ –≤ –ø—Ä–æ–º–ø—Ç

3. **–ñ–∏–≤–∞—è —ç–º–ø–∞—Ç–∏—è**
   ‚Üí –†–∞—Å—à–∏—Ä–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∂–∏–≤—ã—Ö —Ä–µ–∞–∫—Ü–∏–π

4. **–ß—ë—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã**
   ‚Üí –ö–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞

### ‚ö†Ô∏è –ß–¢–û –¢–†–ï–ë–£–ï–¢ –í–ù–ò–ú–ê–ù–ò–Ø:

1. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å**
   ‚Üí P0.2, P0.3, P1.3

2. **–°–º–µ—à–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏**
   ‚Üí P1.1

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ**
   ‚Üí P1.2

4. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–±–æ–∏**
   ‚Üí P0.1

### üí° –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:

1. **–°–∏—Å—Ç–µ–º–∞ —Ñ–ª–∞–≥–æ–≤**
   ‚Üí P1.5

2. **Vision AI**
   ‚Üí P1.2

3. **–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞**
   ‚Üí P2.2

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º –í—è—á–µ—Å–ª–∞–≤–æ–º (1,312 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ 8 –¥–Ω–µ–π) –ø–æ–∫–∞–∑–∞–ª–æ:

**‚úÖ –ë–û–¢ –ì–û–¢–û–í –ö PRODUCTION** —Å –æ—Ü–µ–Ω–∫–æ–π **4.7/5**

–û–¥–Ω–∞–∫–æ –¥–ª—è **–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è** –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
- **–°—Ä–æ—á–Ω–æ (P0):** –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è API, –∑–∞—â–∏—Ç–∞ –ø–∞–º—è—Ç–∏
- **–í–∞–∂–Ω–æ (P1):** –£–ª—É—á—à–µ–Ω–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞
- **–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ (P2):** –ù–æ–≤—ã–µ —Ñ–∏—á–∏ –∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è

**–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 6-8 –Ω–µ–¥–µ–ª—å

**–ö–æ–º–∞–Ω–¥–∞:** 1 —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º–∏

**–ë—é–¥–∂–µ—Ç:** –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞—Ç—Ä–∞—Ç)

---

**–°–æ–∑–¥–∞–Ω–æ:** 29.12.2025  
**–ê–≤—Ç–æ—Ä:** Claude Sonnet 4.5 –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–í–µ—Ä—Å–∏—è –ø–ª–∞–Ω–∞:** 1.0