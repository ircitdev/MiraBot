# План улучшения MIRA BOT

## Анализ тестовой переписки (13.12.2024)

### Выявленные проблемы

1. **Потеря памяти / контекста** (критично)
   - Бот забыл имя "Ниночка" и снова спросил "Как мне к тебе обращаться?"
   - После перезапуска бот начал заново с онбординга
   - Принял "Забыла?" как имя пользователя

2. **Некорректная обработка имени**
   - Принял слово "Называй" как имя (из фразы "Называй меня Ниночка")
   - Сохранил "Забыла?" как display_name

3. **Неправильное определение пола партнёра**
   - "Сашечка мальчик а не девочка" — бот предположил, что Саша девочка

4. **Ошибка сервера**
   - "Прости, что-то пошло не так..." — после этого бот потерял весь контекст

5. **Хорошее**
   - Эмпатичная реакция на грубость ("Иди в жопу")
   - Тёплый, поддерживающий тон
   - Хорошие вопросы для продолжения диалога

---

## 1. Критичные улучшения (высокий приоритет)

### 1.1. Исправление багов из теста
- [x] **Исправить парсинг имени** — извлекать имя из фразы, а не брать всё сообщение ✅
- [x] **Проверить логи ошибки** — найти причину "что-то пошло не так" (конфликт polling) ✅
- [x] **Добавить поле `partner_gender`** — чтобы правильно склонять ✅
- [x] **Graceful error handling** — при ошибке не терять контекст ✅
- [x] **Сохранять partner_name** — спрашивать про партнёра в онбординге ✅

### 1.2. Безопасность
- [ ] Хранение сессий в Redis — сейчас всё в памяти, при перезапуске теряется
- [x] Rate limiting — защита от спама (макс. 1 сообщение в 2 сек) ✅
- [ ] Валидация входных данных — санитизация пользовательского ввода
- [ ] Логирование действий админа — аудит операций

### 1.3. Стабильность
- [ ] Graceful shutdown — корректное завершение при перезапуске
- [ ] Health check endpoint — мониторинг состояния бота
- [x] Retry logic — повторные попытки при ошибках API Claude/Whisper ✅
- [ ] Connection pooling — пул соединений к БД

---

## 2. Функциональные улучшения (средний приоритет)

### 2.1. Улучшение AI-диалога
- [ ] Streaming ответов — отправка по частям (эффект "печатает...")
- [ ] Контекстные подсказки — кнопки быстрых ответов по ситуации
- [ ] Mood tracking — отслеживание эмоционального состояния
- [ ] Персонализация промптов — адаптация стиля под пользователя

### 2.2. Расширение админки
- [ ] Блокировка пользователей — с указанием причины
- [ ] Рассылка сообщений — broadcast всем или по сегментам
- [ ] Экспорт статистики — CSV/Excel отчёты
- [ ] Просмотр истории диалогов — для поддержки

### 2.3. Монетизация
- [ ] Интеграция ЮKassa — реальные платежи (сейчас заглушка)
- [ ] Промокоды — скидки и бесплатные дни
- [ ] Trial период — 3 дня Premium бесплатно
- [ ] Автопродление подписки — рекуррентные платежи

### 2.4. Ритуалы и напоминания
- [ ] Рабочие ритуалы — сейчас только шаблон, нужна реализация
- [ ] Персонализированные check-in — на основе истории
- [ ] Праздничные поздравления — дни рождения, годовщины

---

## 3. UX улучшения (низкий приоритет)

### 3.1. Интерфейс
- [ ] Inline mode — использование бота в других чатах
- [ ] Web App — мини-приложение для настроек и статистики
- [ ] Keyboard shortcuts — быстрые команды через /menu
- [ ] Мультиязычность — английский интерфейс

### 3.2. Контент
- [ ] Библиотека упражнений — дыхательные, релаксация
- [ ] Аффирмации дня — ежедневные мотивационные сообщения
- [ ] Медитации — аудио-гиды (голосовые сообщения)

---

## 4. Технический долг

### 4.1. Код
- [ ] Unit тесты — покрытие критичных функций
- [ ] Типизация — добавить mypy проверки
- [ ] Документация API — docstrings для всех функций
- [ ] Миграции Alembic — автоматические миграции БД

### 4.2. DevOps
- [ ] Docker Compose — запуск одной командой
- [ ] CI/CD pipeline — автодеплой через GitHub Actions
- [ ] Мониторинг — Prometheus + Grafana
- [ ] Бэкапы БД — автоматические ежедневные

---

## Рекомендуемый порядок реализации

| Этап | Задачи | Результат |
|------|--------|-----------|
| **1** | Исправление багов из теста | Корректная работа |
| **2** | Rate limiting, Retry logic, Health check | Стабильная работа |
| **3** | Интеграция ЮKassa, Trial период | Монетизация |
| **4** | Streaming ответов, Mood tracking | Лучший UX |
| **5** | Рассылки, Блокировки, Экспорт | Полная админка |
| **6** | Ритуалы, Медитации | Расширенный функционал |

---

## Changelog

### 13.12.2024
- Создан план на основе тестовой переписки
- Развёрнут бот на сервере 31.44.7.144
- Добавлена админ-панель (/admin)
- Добавлена статистика по типам сообщений (текст/голос)

### 14.12.2024
- Исправлен парсинг имени (utils/text_parser.py)
- Добавлено поле partner_gender в модель User
- Добавлен Rate Limiter (bot/middlewares/rate_limit.py)
- Добавлена Retry логика (utils/retry.py)
- Перезапущен бот после конфликта polling
- Добавлен Graceful error handling (bot/handlers/message.py)
  - Раздельная обработка APIConnectionError, RateLimitError, APIStatusError
  - Сохранение сообщений пользователя при ошибках API
  - Полный traceback в логах
- Добавлен сбор partner_name в онбординге (bot/handlers/message.py)
  - Шаг 2: спрашиваем имя партнёра
  - Автоопределение пола по имени (_detect_gender_by_name)
  - Возможность пропустить этот шаг
