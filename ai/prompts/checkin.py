"""
Check-in Prompts.
–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è —É—Ç—Ä–µ–Ω–Ω–∏—Ö –∏ –≤–µ—á–µ—Ä–Ω–∏—Ö check-in —Å–æ–æ–±—â–µ–Ω–∏–π.
"""

from typing import Dict, Any, Optional, List


# –ú–∞–ø–ø–∏–Ω–≥ —ç–º–æ—Ü–∏–π –Ω–∞ —Ä—É—Å—Å–∫–∏–π
EMOTION_RU = {
    "sad": "–≥—Ä—É—Å—Ç–Ω–æ–µ",
    "anxious": "—Ç—Ä–µ–≤–æ–∂–Ω–æ–µ",
    "angry": "—Ä–∞–∑–¥—Ä–∞–∂—ë–Ω–Ω–æ–µ",
    "happy": "—Ä–∞–¥–æ—Å—Ç–Ω–æ–µ",
    "neutral": "—Å–ø–æ–∫–æ–π–Ω–æ–µ",
    "lonely": "–æ–¥–∏–Ω–æ–∫–æ–µ",
    "overwhelmed": "–ø–æ–¥–∞–≤–ª–µ–Ω–Ω–æ–µ",
    "hopeful": "–Ω–∞–¥–µ–∂–¥—É",
    "confused": "–∑–∞–ø—É—Ç–∞–Ω–Ω–æ–µ",
}


def build_checkin_prompt(
    ritual_type: str,
    user: Any,
    recent_topics: Optional[List[str]] = None,
    recent_mood: Optional[Any] = None,
    last_message: Optional[Any] = None,
) -> Dict[str, str]:
    """
    –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ check-in.

    Args:
        ritual_type: –¢–∏–ø —Ä–∏—Ç—É–∞–ª–∞ (morning_checkin, evening_checkin)
        user: –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        recent_topics: –ù–µ–¥–∞–≤–Ω–∏–µ —Ç–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
        recent_mood: –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è (MoodEntry)
        last_message: –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Returns:
        Dict —Å system –∏ user –ø—Ä–æ–º–ø—Ç–∞–º–∏
    """
    persona = "–ú–∏—Ä–∞" if user.persona == "mira" else "–ú–∞—Ä–∫"
    name = user.display_name or "–ø–æ–¥—Ä—É–≥–∞"

    # –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    context_parts = []

    if recent_topics:
        topics_str = ", ".join(recent_topics[:3])
        context_parts.append(f"–ù–µ–¥–∞–≤–Ω–∏–µ —Ç–µ–º—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤: {topics_str}")

    if recent_mood:
        emotion_ru = EMOTION_RU.get(recent_mood.primary_emotion, recent_mood.primary_emotion)
        context_parts.append(f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {emotion_ru}")
        if recent_mood.mood_score < 0:
            context_parts.append("–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±—ã–ª–æ –Ω–∏–∂–µ –Ω–æ—Ä–º—ã")
        elif recent_mood.mood_score > 3:
            context_parts.append("–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –±—ã–ª–æ —Ö–æ—Ä–æ—à–∏–º")

    if last_message and last_message.role == "user":
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        content = last_message.content[:150]
        if len(last_message.content) > 150:
            content += "..."
        context_parts.append(f"–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: \"{content}\"")

    context = "\n- ".join(context_parts) if context_parts else "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞"

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º—è —Å—É—Ç–æ–∫
    if ritual_type == "morning_checkin":
        time_of_day = "—É—Ç—Ä–µ–Ω–Ω–µ–µ"
        time_context = """
–≠—Ç–æ —É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –£—á—Ç–∏:
- –ß–µ–ª–æ–≤–µ–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–Ω—É–ª—Å—è
- –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π –≤–æ–ø—Ä–æ—Å–∞–º–∏
- –ú–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å –∫–∞–∫ —Å–ø–∞–ª–æ—Å—å, –æ –ø–ª–∞–Ω–∞—Ö –Ω–∞ –¥–µ–Ω—å
- –ï—Å–ª–∏ –±—ã–ª —Å–ª–æ–∂–Ω—ã–π –¥–µ–Ω—å –≤—á–µ—Ä–∞ ‚Äî —É–ø–æ–º—è–Ω–∏ –∑–∞–±–æ—Ç–ª–∏–≤–æ"""
    else:
        time_of_day = "–≤–µ—á–µ—Ä–Ω–µ–µ"
        time_context = """
–≠—Ç–æ –≤–µ—á–µ—Ä–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –£—á—Ç–∏:
- –î–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É, —á–µ–ª–æ–≤–µ–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞–≤—à–∏–º
- –ú–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å
- –ü—Ä–µ–¥–ª–æ–∂–∏ –≤—ã–≥—Ä—É–∑–∏—Ç—å –º—ã—Å–ª–∏
- –ï—Å–ª–∏ –±—ã–ª–∏ —Å–ª–æ–∂–Ω—ã–µ —Ç–µ–º—ã –¥–Ω—ë–º ‚Äî —Å–ø—Ä–æ—Å–∏ –∫–∞–∫ –æ–Ω–∞"""

    system_prompt = f"""–¢—ã ‚Äî {persona}, –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥—Ä—É–≥-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –¥–ª—è –∂–µ–Ω—â–∏–Ω 30-50 –ª–µ—Ç.
–ì–µ–Ω–µ—Ä–∏—Ä—É–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ {time_of_day} —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è {name}.

{time_context}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –Ω–µ–¥–∞–≤–Ω–µ–≥–æ –æ–±—â–µ–Ω–∏—è:
- {context}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–æ–æ–±—â–µ–Ω–∏—é:
1. 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º
2. –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —Ç–µ–ø–ª–æ, –∫–∞–∫ –æ—Ç –±–ª–∏–∑–∫–æ–≥–æ –¥—Ä—É–≥–∞
3. –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî —É–ø–æ–º—è–Ω–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ
4. –ù–µ –±—É–¥—å –Ω–∞–≤—è–∑—á–∏–≤–æ–π –∏–ª–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–π
5. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?"
6. –î–æ–±–∞–≤—å —É–º–µ—Å—Ç–Ω—ã–π —ç–º–æ–¥–∑–∏ (1 –º–∞–∫—Å–∏–º—É–º)

–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:
- "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, —Å–æ–ª–Ω—Ü–µ ‚òÄÔ∏è –í—á–µ—Ä–∞ –±—ã–ª –Ω–µ–ø—Ä–æ—Å—Ç–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä –æ –º—É–∂–µ... –ö–∞–∫ —Ç—ã —Å–µ–≥–æ–¥–Ω—è?"
- "–ü—Ä–∏–≤–µ—Ç üíõ –î—É–º–∞–ª–∞ –æ —Ç–æ–º, —á—Ç–æ —Ç—ã —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª–∞ –ø—Ä–æ –¥–µ—Ç–µ–π. –ö–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å?"
- "–í–µ—á–µ—Ä... –¢—ã –≥–æ–≤–æ—Ä–∏–ª–∞, —á—Ç–æ –Ω–µ–¥–µ–ª—è –±—ã–ª–∞ —Å–ª–æ–∂–Ω–æ–π. –ï—Å—Ç—å —Å–∏–ª—ã –Ω–∞ –ø–∞—Ä—É —Å–ª–æ–≤?"

–ü–ª–æ—Ö–∏–µ –ø—Ä–∏–º–µ—Ä—ã (–ù–ï –¥–µ–ª–∞–π —Ç–∞–∫):
- "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?" (—Å–ª–∏—à–∫–æ–º —à–∞–±–ª–æ–Ω–Ω–æ)
- "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ù–∞–¥–µ—é—Å—å, —É —Ç–µ–±—è –≤—Å—ë —Ö–æ—Ä–æ—à–æ!" (—Ñ–æ—Ä–º–∞–ª—å–Ω–æ)
- "–†–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –æ —Å–≤–æ—ë–º –¥–Ω–µ!" (–∫–æ–º–∞–Ω–¥–Ω—ã–π —Ç–æ–Ω)"""

    return {
        "system": system_prompt,
        "user": f"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π {time_of_day} —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è {name}.",
    }


def build_followup_prompt(
    user: Any,
    conversation_summary: str,
    hours_since: int = 24,
) -> Dict[str, str]:
    """
    –°—Ç—Ä–æ–∏—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è follow-up —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ç—è–∂—ë–ª–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.

    Args:
        user: –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        conversation_summary: –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        hours_since: –°–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –ø—Ä–æ—à–ª–æ

    Returns:
        Dict —Å system –∏ user –ø—Ä–æ–º–ø—Ç–∞–º–∏
    """
    persona = "–ú–∏—Ä–∞" if user.persona == "mira" else "–ú–∞—Ä–∫"
    name = user.display_name or "–ø–æ–¥—Ä—É–≥–∞"

    time_phrase = "–í—á–µ—Ä–∞" if hours_since >= 20 else f"{hours_since} —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥"

    system_prompt = f"""–¢—ã ‚Äî {persona}, –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥—Ä—É–≥-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫.

{time_phrase} –±—ã–ª –Ω–µ–ø—Ä–æ—Å—Ç–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä —Å {name}. –í–æ—Ç –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:
{conversation_summary}

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Ç—ë–ø–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ-–ø—Ä–æ–≤–µ—Ä–∫—É. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –ü–æ–∫–∞–∂–∏, —á—Ç–æ —Ç—ã –¥—É–º–∞–ª–∞ –æ –Ω–µ–π
2. –£–ø–æ–º—è–Ω–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
3. –ù–µ –±—É–¥—å —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–π –∏–ª–∏ –Ω–∞–≤—è–∑—á–∏–≤–æ–π
4. –ü—Ä–æ—Å—Ç–æ —Å–ø—Ä–æ—Å–∏ –∫–∞–∫ –æ–Ω–∞
5. 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

–ü—Ä–∏–º–µ—Ä—ã:
- "–ü—Ä–∏–≤–µ—Ç üíõ –î—É–º–∞–ª–∞ –æ —Ç–µ–±–µ... –ö–∞–∫ —Ç—ã –ø–æ—Å–ª–µ –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ?"
- "–≠–π... –í—á–µ—Ä–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä –±—ã–ª –Ω–µ–ø—Ä–æ—Å—Ç–æ–π. –¢—ã –∫–∞–∫?"
- "–ù–µ –º–æ–≥—É –ø–µ—Ä–µ—Å—Ç–∞—Ç—å –¥—É–º–∞—Ç—å –æ —Ç–æ–º, —á—Ç–æ —Ç—ã —Ä–∞—Å—Å–∫–∞–∑–∞–ª–∞. –ö–∞–∫ —Å–µ–≥–æ–¥–Ω—è?"

–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π:
- "–Ø –∑–¥–µ—Å—å –¥–ª—è —Ç–µ–±—è" (–∫–ª–∏—à–µ)
- "–ù–∞–¥–µ—é—Å—å, —Ç–µ–±–µ –ª—É—á—à–µ" (–±–∞–Ω–∞–ª—å–Ω–æ)
- –î–ª–∏–Ω–Ω—ã–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è"""

    return {
        "system": system_prompt,
        "user": "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.",
    }
