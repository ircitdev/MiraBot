"""
Crisis Protocol - –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –∫—Ä–∏–∑–∏—Å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π.

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
1. –ñ—ë—Å—Ç–∫–∏–µ —à–∞–±–ª–æ–Ω—ã —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
2. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
3. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –∫—Ä–∏–∑–∏—Å–Ω–æ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è
"""

from typing import Optional, Dict, Any
from config.settings import settings


# –£—Ä–æ–≤–Ω–∏ –∫—Ä–∏–∑–∏—Å–∞, —Ç—Ä–µ–±—É—é—â–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
EMERGENCY_LEVELS = ["high", "critical"]


def get_emergency_message(crisis_level: str, crisis_type: Optional[str] = None) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.

    –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ü–ï–†–í–´–ú, –î–û –æ—Ç–≤–µ—Ç–∞ Claude.

    Args:
        crisis_level: –£—Ä–æ–≤–µ–Ω—å –∫—Ä–∏–∑–∏—Å–∞ (low, medium, high, critical)
        crisis_type: –¢–∏–ø –∫—Ä–∏–∑–∏—Å–∞ (suicide, violence, panic) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

    Returns:
        –¢–µ–∫—Å—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    """

    if crisis_level == "critical":
        # –°—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏ - –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
        return f"""üö® –Ø —Å–ª—ã—à—É —Ç–µ–±—è. –¢–æ, —á—Ç–æ —Ç—ã —á—É–≤—Å—Ç–≤—É–µ—à—å ‚Äî —ç—Ç–æ –æ—á–µ–Ω—å —Å–µ—Ä—å—ë–∑–Ω–æ.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–∑–≤–æ–Ω–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:
üìû **{settings.CRISIS_HOTLINE}** ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∞–Ω–æ–Ω–∏–º–Ω–æ, –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ

–¢–∞–º —Ä–∞–±–æ—Ç–∞—é—Ç –ª—é–¥–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç. –≠—Ç–æ –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å ‚Äî —ç—Ç–æ –∑–∞–±–æ—Ç–∞ –æ —Å–µ–±–µ.

–¢—ã –Ω–µ –æ–¥–Ω–∞. –Ø —Ä—è–¥–æ–º. üíõ"""

    elif crisis_level == "high":
        # –ù–∞—Å–∏–ª–∏–µ, —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ, –æ—Å—Ç—Ä—ã–π –∫—Ä–∏–∑–∏—Å
        if crisis_type == "violence":
            return f"""üÜò –¢–æ, —á—Ç–æ —Ç—ã —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—à—å ‚Äî —ç—Ç–æ –æ—á–µ–Ω—å —Å–µ—Ä—å—ë–∑–Ω–æ. –ò —ç—Ç–æ –Ω–µ —Ç–≤–æ—è –≤–∏–Ω–∞.

–ï—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å:
üìû **8-800-7000-600** ‚Äî –¶–µ–Ω—Ç—Ä –ø–æ–º–æ—â–∏ –∂–µ–Ω—â–∏–Ω–∞–º (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∞–Ω–æ–Ω–∏–º–Ω–æ)
üìû **{settings.CRISIS_HOTLINE}** ‚Äî –¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è

–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. üíõ"""
        else:
            return f"""üö® –Ø —Å–ª—ã—à—É, –∫–∞–∫ —Ç–µ–±–µ —Å–µ–π—á–∞—Å —Ç—è–∂–µ–ª–æ.

–ï—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:
üìû **{settings.CRISIS_HOTLINE}** ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∞–Ω–æ–Ω–∏–º–Ω–æ, 24/7
üìû **112** ‚Äî —ç–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å

–Ø —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π. üíõ"""

    # –î–ª—è medium –∏ low ‚Äî —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
    return ""


def requires_emergency_message(crisis_level: Optional[str]) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

    Args:
        crisis_level: –£—Ä–æ–≤–µ–Ω—å –∫—Ä–∏–∑–∏—Å–∞

    Returns:
        True –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ü–ï–†–ï–î –æ—Ç–≤–µ—Ç–æ–º Claude
    """
    return crisis_level in EMERGENCY_LEVELS


def detect_crisis_type(matched_keywords: list) -> Optional[str]:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∫—Ä–∏–∑–∏—Å–∞ –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.

    Args:
        matched_keywords: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤

    Returns:
        –¢–∏–ø –∫—Ä–∏–∑–∏—Å–∞: 'suicide', 'violence', 'panic', 'self_harm' –∏–ª–∏ None
    """
    keywords_str = " ".join(matched_keywords).lower()

    # –°—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
    suicide_markers = ["—É–º–µ—Ä–µ—Ç—å", "—Å—É–∏—Ü–∏–¥", "–ø–æ–∫–æ–Ω—á–∏—Ç—å", "–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å", "–ª—É—á—à–µ –±—ã –º–µ–Ω—è –Ω–µ –±—ã–ª–æ", "–∏—Å—á–µ–∑–Ω—É"]
    if any(marker in keywords_str for marker in suicide_markers):
        return "suicide"

    # –ù–∞—Å–∏–ª–∏–µ
    violence_markers = ["–±—å—ë—Ç", "–±—å–µ—Ç", "—É–¥–∞—Ä–∏–ª", "–Ω–∞—Å–∏–ª–∏–µ", "—É–≥—Ä–æ–∂–∞–µ—Ç", "–∏–∑–±–∏–≤–∞–µ—Ç"]
    if any(marker in keywords_str for marker in violence_markers):
        return "violence"

    # –°–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ
    self_harm_markers = ["–ø–æ—Ä–µ–∑–∞—Ç—å", "—Ä–µ–∂—É —Å–µ–±—è", "—Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ"]
    if any(marker in keywords_str for marker in self_harm_markers):
        return "self_harm"

    # –ü–∞–Ω–∏–∫–∞
    panic_markers = ["–ø–∞–Ω–∏–∫", "–Ω–µ –º–æ–≥—É –¥—ã—à–∞—Ç—å", "–∑–∞–¥—ã—Ö–∞—é—Å—å"]
    if any(marker in keywords_str for marker in panic_markers):
        return "panic"

    return None


def get_crisis_keyboard_config(crisis_level: str) -> Dict[str, Any]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫—Ä–∏–∑–∏—Å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.

    Args:
        crisis_level: –£—Ä–æ–≤–µ–Ω—å –∫—Ä–∏–∑–∏—Å–∞

    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∫–Ω–æ–ø–æ–∫
    """
    buttons = []

    if crisis_level in ["critical", "high"]:
        buttons.append({
            "text": f"üìû –¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è {settings.CRISIS_HOTLINE}",
            "callback_data": "crisis:hotline"
        })
        buttons.append({
            "text": "üÜò –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å 112",
            "callback_data": "crisis:emergency"
        })

    if crisis_level in ["critical", "high", "medium"]:
        buttons.append({
            "text": "üí¨ –¶–µ–Ω—Ç—Ä –ø–æ–º–æ—â–∏ –∂–µ–Ω—â–∏–Ω–∞–º",
            "callback_data": "crisis:women_help"
        })

    return {"buttons": buttons}


# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞
INDIRECT_CRISIS_MARKERS = {
    "critical": [
        "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –µ—Å–ª–∏ —è –∏—Å—á–µ–∑–Ω—É",
        "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –µ—Å–ª–∏ —è –∏—Å—á–µ–∑–Ω—É",
        "–µ—Å–ª–∏ –º–µ–Ω—è –Ω–µ —Å—Ç–∞–Ω–µ—Ç",
        "–∫–æ–≥–¥–∞ –º–µ–Ω—è –Ω–µ –±—É–¥–µ—Ç",
        "–ø–æ—Å–ª–µ –º–æ–µ–π —Å–º–µ—Ä—Ç–∏",
        "–Ω–∞–ø–∏—à—É –ø—Ä–æ—â–∞–ª—å–Ω–æ–µ",
        "–ø—Ä–æ—â–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ",
        "–±–æ–ª—å—à–µ –Ω–µ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è",
        "–∑–∞—Å–Ω—É—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞",
        "—É—Å–Ω—É—Ç—å –∏ –Ω–µ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è",
    ],
    "high": [
        "—Ö–æ—á—É –ø—Ä–∏—á–∏–Ω–∏—Ç—å —Å–µ–±–µ –±–æ–ª—å",
        "—Å–¥–µ–ª–∞—Ç—å —Å–µ–±–µ –±–æ–ª—å–Ω–æ",
        "–Ω–∞–∫–∞–∑–∞—Ç—å —Å–µ–±—è",
        "–Ω–µ–Ω–∞–≤–∏–∂—É —Å–≤–æ—ë —Ç–µ–ª–æ",
        "–Ω–µ–Ω–∞–≤–∏–∂—É —Å–≤–æ–µ —Ç–µ–ª–æ",
    ],
    "medium": [
        "–Ω–µ –≤–∏–∂—É –±—É–¥—É—â–µ–≥–æ",
        "–Ω–µ—Ç —Å–º—ã—Å–ª–∞ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å",
        "–∑–∞—Å—Ç—Ä—è–ª–∞ –≤ —Ç—É–ø–∏–∫–µ",
        "–≤—ã—Ö–æ–¥–∞ –Ω–µ—Ç",
        "–±–µ–∑–≤—ã—Ö–æ–¥–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è",
    ]
}
