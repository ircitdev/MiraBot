"""
–î–µ—Ç–µ–∫—Ç–æ—Ä —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞.
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç—ã–º, –æ—Ç–∫—Ä—ã—Ç—ã–º –∏–ª–∏ —Ä–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º.
"""

from typing import Optional, Dict, Any
from loguru import logger


class QuestionTypeDetector:
    """–î–µ—Ç–µ–∫—Ç–∏—Ç —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

    # –ú–∞—Ä–∫–µ—Ä—ã –∑–∞–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (—Ç—Ä–µ–±—É—é—Ç –¥–∞/–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞)
    CLOSED_QUESTION_PATTERNS = [
        "–ø—Ä–∞–≤–¥–∞?", "–¥–∞?", "–Ω–µ—Ç?", "–≤–µ–¥—å?", "–≤–µ—Ä–Ω–æ?",
        "—Ç–∞–∫ –ª–∏", "–Ω–µ —Ç–∞–∫ –ª–∏", "—Ä–∞–∑–≤–µ", "–Ω–µ—É–∂–µ–ª–∏",
        "–º–æ–∂–µ—Ç –±—ã—Ç—å", "–º–æ–∂–µ—Ç",
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
        "–ø—Ä–∞–≤–¥–∞ –≤–µ–¥—å", "–Ω–µ –ø—Ä–∞–≤–¥–∞ –ª–∏",
        "—Å–æ–≥–ª–∞—Å–Ω–∞?", "–ø–æ–Ω–∏–º–∞–µ—à—å?",
    ]

    # –ú–∞—Ä–∫–µ—Ä—ã –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (—Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)
    OPEN_QUESTION_PATTERNS = [
        "—á—Ç–æ –¥–µ–ª–∞—Ç—å", "–∫–∞–∫ –±—ã—Ç—å", "–∫–∞–∫ –ø–æ—Å—Ç—É–ø–∏—Ç—å",
        "—á—Ç–æ –º–Ω–µ", "–∫–∞–∫ –º–Ω–µ", "–ø–æ—á–µ–º—É",
        "–∑–∞—á–µ–º", "–æ—Ç–∫—É–¥–∞", "–∫—É–¥–∞",
        "–∫–∞–∫", "–∫–æ–≥–¥–∞", "–≥–¥–µ",
        "—á—Ç–æ –¥—É–º–∞–µ—à—å", "–∫–∞–∫ –¥—É–º–∞–µ—à—å",
        "—á—Ç–æ –ø–æ—Å–æ–≤–µ—Ç—É–µ—à—å", "—á—Ç–æ —Å–∫–∞–∂–µ—à—å",
    ]

    # –ú–∞—Ä–∫–µ—Ä—ã —Ä–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–Ω–µ —Ç—Ä–µ–±—É—é—Ç –ø—Ä—è–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞)
    RHETORICAL_PATTERNS = [
        "–Ω—É –ø–æ—á–µ–º—É", "–∑–∞ —á—Ç–æ",
        "–∫–æ–≥–¥–∞ –∂–µ", "—Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ",
        "–¥–æ –∫–∞–∫–∏—Ö –ø–æ—Ä", "—á—Ç–æ –∂–µ –º–Ω–µ",
        "—á—Ç–æ —Å–æ –º–Ω–æ–π", "—á—Ç–æ —Å –Ω–∏–º",
        "–Ω—É –∫–∞–∫ —Ç–∞–∫", "–∫–∞–∫ –∂–µ —Ç–∞–∫",
    ]

    # –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö
    EMOTIONAL_QUESTIONS = [
        "—É—Å—Ç–∞–ª–∞", "–∏–∑–º—É—á–∏–ª–∞—Å—å", "–∑–∞–¥–æ–ª–±–∞–ª–æ",
        "–¥–æ—Å—Ç–∞–ª–æ", "–Ω–∞–¥–æ–µ–ª–æ", "–∑–∞–º—É—á–∏–ª–∞—Å—å",
    ]

    # –ú–∞—Ä–∫–µ—Ä—ã "—Ä—ã–±–∞–ª–∫–∏ –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ" (validation seeking)
    FISHING_PATTERNS = [
        # –ü–æ–∏—Å–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–≤–æ–µ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
        "—è –∂–µ", "–≤–µ–¥—å —è", "—Ä–∞–∑–≤–µ —è",
        # –°–æ–º–Ω–µ–Ω–∏—è –≤ —Å–µ–±–µ
        "–ø–ª–æ—Ö–∞—è –º–∞—Ç—å", "–ø–ª–æ—Ö–∞—è –∂–µ–Ω–∞", "–ø–ª–æ—Ö–æ–π —á–µ–ª–æ–≤–µ–∫",
        "—Ö–æ—Ä–æ—à–∞—è –º–∞—Ç—å", "—Ö–æ—Ä–æ—à–∞—è –∂–µ–Ω–∞", "—Ö–æ—Ä–æ—à–∏–π —á–µ–ª–æ–≤–µ–∫",  # –¢–æ–∂–µ –∏—â—É—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        "–Ω–æ—Ä–º–∞–ª—å–Ω–æ —á—Ç–æ", "—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ",
        # –ü–æ–∏—Å–∫ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏—è
        "—è –ø—Ä–∞–≤–∞", "—è –Ω–µ –ø—Ä–∞–≤–∞", "–≤–∏–Ω–æ–≤–∞—Ç–∞",
        # –°–∞–º–æ–∫—Ä–∏—Ç–∏–∫–∞ –≤ –≤–æ–ø—Ä–æ—Å–µ
        "—á—Ç–æ —Å–æ –º–Ω–æ–π –Ω–µ —Ç–∞–∫", "—á—Ç–æ —è –¥–µ–ª–∞—é –Ω–µ —Ç–∞–∫",
    ]

    def detect(self, message: str) -> Optional[Dict[str, Any]]:
        """
        –î–µ—Ç–µ–∫—Ç–∏—Ç —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏.

        Args:
            message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            Dict —Å —Ç–∏–ø–æ–º –≤–æ–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π –∏–ª–∏ None
        """
        message_lower = message.lower().strip()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
        if "?" not in message:
            return None

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –≤–æ–ø—Ä–æ—Å–æ–º
        sentences = message_lower.split(".")
        question_sentence = ""
        for sentence in reversed(sentences):
            if "?" in sentence:
                question_sentence = sentence.strip()
                break

        if not question_sentence:
            return None

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º "—Ä—ã–±–∞–ª–∫—É –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ" (–Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)
        if self._is_fishing(question_sentence):
            return {
                "type": "fishing",
                "question": question_sentence,
                "response_strategy": "reflect_not_validate",
                "instruction": (
                    "üé£ FISHING QUESTION ‚Äî –∏—â–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è/–≤–∞–ª–∏–¥–∞—Ü–∏–∏! "
                    "–ù–ï –¥–∞–≤–∞–π –ø—Ä—è–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ('–ö–æ–Ω–µ—á–Ω–æ –Ω–µ—Ç!', '–¢—ã –æ—Ç–ª–∏—á–Ω–∞—è –º–∞—Ç—å!'). "
                    "–í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø–æ–º–æ–≥–∏ –†–ê–ó–û–ë–†–ê–¢–¨–°–Ø: "
                    "'–ê –ø–æ—á–µ–º—É —Ç—ã –æ–± —ç—Ç–æ–º –ø–æ–¥—É–º–∞–ª–∞?', '–ß—Ç–æ –∑–∞—Å—Ç–∞–≤–∏–ª–æ —É—Å–æ–º–Ω–∏—Ç—å—Å—è?', "
                    "'–û—Ç–∫—É–¥–∞ —ç—Ç–æ –æ—â—É—â–µ–Ω–∏–µ?'. "
                    "–¶–µ–ª—å: –≥–ª—É–±–∏–Ω–∞, –∞ –Ω–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ–µ —É—Ç–µ—à–µ–Ω–∏–µ."
                )
            }

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å
        if self._is_rhetorical(question_sentence):
            return {
                "type": "rhetorical",
                "question": question_sentence,
                "response_strategy": "validate_no_answer",
                "instruction": (
                    "–≠—Ç–æ —Ä–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å ‚Äî –ù–ï –æ—Ç–≤–µ—á–∞–π –Ω–∞ –Ω–µ–≥–æ –ø—Ä—è–º–æ! "
                    "–í–º–µ—Å—Ç–æ –æ—Ç–≤–µ—Ç–∞ ‚Äî –≤–∞–ª–∏–¥–∏—Ä—É–π —á—É–≤—Å—Ç–≤–∞: '–î–∞, —ç—Ç–æ —Ç—è–∂–µ–ª–æ...', "
                    "'–ü–æ–Ω–∏–º–∞—é —Ç–≤–æ—ë —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ...'. –î–∞–π –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è."
                )
            }

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–∫—Ä—ã—Ç—ã–π –≤–æ–ø—Ä–æ—Å
        if self._is_closed(question_sentence):
            return {
                "type": "closed",
                "question": question_sentence,
                "response_strategy": "brief_then_reflect",
                "instruction": (
                    "–ó–∞–∫—Ä—ã—Ç—ã–π –≤–æ–ø—Ä–æ—Å (–¥–∞/–Ω–µ—Ç). –û—Ç–≤–µ—Ç—å –ö–†–ê–¢–ö–û (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è), "
                    "–∑–∞—Ç–µ–º –∑–∞–¥–∞–π —Ä–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å —á—Ç–æ–±—ã —É–≥–ª—É–±–∏—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä. "
                    "–ü—Ä–∏–º–µ—Ä: '–î–∞, –ø–æ–Ω–∏–º–∞—é. –ê —á—Ç–æ —Ç–µ–±—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç?'"
                )
            }

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–π –≤–æ–ø—Ä–æ—Å
        if self._is_open(question_sentence):
            return {
                "type": "open",
                "question": question_sentence,
                "response_strategy": "detailed_with_examples",
                "instruction": (
                    "–û—Ç–∫—Ä—ã—Ç—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî –¥–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç. "
                    "–ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã, –≤–∞—Ä–∏–∞–Ω—Ç—ã, –∏—Å—Ç–æ—Ä–∏—é. "
                    "–ù–æ –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π ‚Äî 3-4 –∞–±–∑–∞—Ü–∞ max."
                )
            }

        # –ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å –Ω–æ —Ç–∏–ø –Ω–µ—è—Å–µ–Ω ‚Äî —Å—á–∏—Ç–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–º
        return {
            "type": "open",
            "question": question_sentence,
            "response_strategy": "detailed_with_examples",
            "instruction": (
                "–í–æ–ø—Ä–æ—Å (—Ç–∏–ø –Ω–µ—è—Å–µ–Ω, —Å—á–∏—Ç–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–º). "
                "–î–∞–π —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏."
            )
        }

    def _is_fishing(self, question: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å '—Ä—ã–±–∞–ª–∫–æ–π –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ'."""
        for pattern in self.FISHING_PATTERNS:
            if pattern in question:
                return True

        return False

    def _is_rhetorical(self, question: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å —Ä–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º."""
        # –†–∏—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å —á–∞—Å—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤
        for pattern in self.RHETORICAL_PATTERNS:
            if pattern in question:
                return True

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Å "–∫–∞–∫", "–ø–æ—á–µ–º—É"
        # –ù–∞–ø—Ä–∏–º–µ—Ä: "–ü–æ—á–µ–º—É —è —Ç–∞–∫–∞—è –¥—É—Ä–∞?", "–ö–∞–∫ –º–Ω–µ —Ç–∞–∫ –≤–µ–∑—ë—Ç?"
        if any(emot in question for emot in self.EMOTIONAL_QUESTIONS):
            if any(word in question for word in ["–ø–æ—á–µ–º—É", "–∫–∞–∫", "–∑–∞—á–µ–º"]):
                return True

        return False

    def _is_closed(self, question: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç—ã–º (–¥–∞/–Ω–µ—Ç)."""
        for pattern in self.CLOSED_QUESTION_PATTERNS:
            if pattern in question:
                return True

        # –í–æ–ø—Ä–æ—Å—ã –≤–∏–¥–∞ "–£—Å—Ç–∞–ª–∞, –ø—Ä–∞–≤–¥–∞?"
        if "," in question:
            parts = question.split(",")
            if len(parts) == 2:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ç–æ—Ä—É—é —á–∞—Å—Ç—å
                if any(p in parts[1] for p in ["–ø—Ä–∞–≤–¥–∞", "–¥–∞", "–Ω–µ—Ç", "–≤–µ–¥—å"]):
                    return True

        return False

    def _is_open(self, question: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–æ–ø—Ä–æ—Å –æ—Ç–∫—Ä—ã—Ç—ã–º."""
        for pattern in self.OPEN_QUESTION_PATTERNS:
            if question.startswith(pattern) or f" {pattern}" in question:
                return True

        return False


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
question_type_detector = QuestionTypeDetector()
