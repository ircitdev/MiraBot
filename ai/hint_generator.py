"""
Hint Generator.
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (–∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.
"""

import re
from typing import List, Dict, Any, Optional
from dataclasses import dataclass
from loguru import logger


@dataclass
class Hint:
    """–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞."""
    text: str  # –¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
    message: str  # –°–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
    priority: int = 0  # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–≤—ã—à–µ = –≤–∞–∂–Ω–µ–µ)


class HintGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫."""

    # –ú–∞–∫—Å–∏–º—É–º –∫–Ω–æ–ø–æ–∫ –≤ —Ä—è–¥—É
    MAX_HINTS = 3

    # –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Ç–µ–≥–∞–º/—Ç–µ–º–∞–º
    TOPIC_HINTS = {
        "topic:husband": [
            Hint("–†–∞—Å—Å–∫–∞–∂—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ", "–•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å –º—É–∂–µ–º...", 5),
            Hint("–ê –∫–∞–∫ —É —Ç–µ–±—è?", "–ê –∫–∞–∫ —É —Ç–µ–±—è —Å –ê–Ω–¥—Ä–µ–µ–º? –ë—ã–≤–∞–µ—Ç —Ç–∞–∫ –∂–µ?", 3),
            Hint("–ù–µ –∑–Ω–∞—é —á—Ç–æ –¥–µ–ª–∞—Ç—å", "–ß–µ—Å—Ç–Ω–æ, –Ω–µ –∑–Ω–∞—é —á—Ç–æ —Å —ç—Ç–∏–º –¥–µ–ª–∞—Ç—å...", 4),
        ],
        "topic:children": [
            Hint("–†–∞—Å—Å–∫–∞–∂—É –µ—â—ë", "–•–æ—á—É –µ—â—ë —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ –¥–µ—Ç–µ–π...", 4),
            Hint("–Ø —É—Å—Ç–∞–ª–∞", "–Ø –ø—Ä–æ—Å—Ç–æ –æ—á–µ–Ω—å —É—Å—Ç–∞–ª–∞ –æ—Ç –≤—Å–µ–≥–æ —ç—Ç–æ–≥–æ...", 5),
            Hint("–ù—É–∂–µ–Ω —Å–æ–≤–µ—Ç", "–ú–Ω–µ –Ω—É–∂–µ–Ω —Å–æ–≤–µ—Ç, –∫–∞–∫ –±—ã—Ç—å...", 3),
        ],
        "topic:self": [
            Hint("–•–æ—á—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è", "–•–æ—á—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Å–µ–±–µ...", 5),
            Hint("–ß—É–≤—Å—Ç–≤—É—é –ø—É—Å—Ç–æ—Ç—É", "–ß—É–≤—Å—Ç–≤—É—é –∫–∞–∫—É—é-—Ç–æ –ø—É—Å—Ç–æ—Ç—É –≤–Ω—É—Ç—Ä–∏...", 4),
            Hint("–ú–µ—á—Ç–∞—é –æ...", "–ó–Ω–∞–µ—à—å, —è –º–µ—á—Ç–∞—é –æ...", 3),
        ],
        "topic:relatives": [
            Hint("–û–Ω–∞ –º–µ–Ω—è –±–µ—Å–∏—Ç", "–ß–µ—Å—Ç–Ω–æ? –û–Ω–∞ –º–µ–Ω—è –ø—Ä–æ—Å—Ç–æ –±–µ—Å–∏—Ç...", 4),
            Hint("–ù–µ –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å –Ω–µ—Ç", "–Ø –Ω–µ –º–æ–≥—É –µ–π –æ—Ç–∫–∞–∑–∞—Ç—å, –∏ —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞...", 5),
            Hint("–ú—É–∂ –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç", "–ú—É–∂ –Ω–µ –≤—Å—Ç–∞—ë—Ç –Ω–∞ –º–æ—é —Å—Ç–æ—Ä–æ–Ω—É...", 4),
        ],
        "topic:intimacy": [
            Hint("–ú–Ω–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç", "–ú–Ω–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –±–ª–∏–∑–æ—Å—Ç–∏...", 5),
            Hint("–û–Ω –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç", "–û–Ω –ø—Ä–æ—Å—Ç–æ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, —á–µ–≥–æ —è —Ö–æ—á—É...", 4),
            Hint("–ë–æ—é—Å—å –≥–æ–≤–æ—Ä–∏—Ç—å", "–ë–æ—é—Å—å –æ–± —ç—Ç–æ–º –≥–æ–≤–æ—Ä–∏—Ç—å —Å –Ω–∏–º...", 4),
        ],
        "topic:work": [
            Hint("–í—ã–≥–æ—Ä–∞—é", "–ö–∞–∂–µ—Ç—Å—è, —è –≤—ã–≥–æ—Ä–∞—é –Ω–∞ —Ä–∞–±–æ—Ç–µ...", 5),
            Hint("–•–æ—á—É —É–π—Ç–∏", "–î—É–º–∞—é —É–π—Ç–∏, –Ω–æ —Å—Ç—Ä–∞—à–Ω–æ...", 4),
            Hint("–ù–µ —Ü–µ–Ω—è—Ç", "–ß—É–≤—Å—Ç–≤—É—é, —á—Ç–æ –º–µ–Ω—è –Ω–µ —Ü–µ–Ω—è—Ç...", 4),
        ],
    }

    # –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
    EMOTION_HINTS = {
        "sad": [
            Hint("–ú–Ω–µ –≥—Ä—É—Å—Ç–Ω–æ", "–ú–Ω–µ –ø—Ä–æ—Å—Ç–æ –≥—Ä—É—Å—Ç–Ω–æ —Å–µ–π—á–∞—Å...", 5),
            Hint("–•–æ—á—É –ø–æ–ø–ª–∞–∫–∞—Ç—å", "–•–æ—á–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–æ –ø–æ–ø–ª–∞–∫–∞—Ç—å...", 4),
            Hint("–û–±–Ω–∏–º–∏ –º–µ–Ω—è", "–ü—Ä–æ—Å—Ç–æ –æ–±–Ω–∏–º–∏ –º–µ–Ω—è —Å–ª–æ–≤–∞–º–∏ üíõ", 6),
        ],
        "anxious": [
            Hint("–¢—Ä–µ–≤–æ–∂–Ω–æ", "–ú–Ω–µ –æ—á–µ–Ω—å —Ç—Ä–µ–≤–æ–∂–Ω–æ...", 5),
            Hint("–ù–µ –º–æ–≥—É —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è", "–ù–∏–∫–∞–∫ –Ω–µ –º–æ–≥—É —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è...", 4),
            Hint("–ß—Ç–æ —Å–æ –º–Ω–æ–π?", "–ù–µ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —Å–æ –º–Ω–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç...", 4),
        ],
        "angry": [
            Hint("–ó–ª—é—Å—å", "–Ø –∑–ª—é—Å—å, –∏ –Ω–µ –º–æ–≥—É –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è...", 5),
            Hint("–•–æ—á—É –≤—ã—Å–∫–∞–∑–∞—Ç—å—Å—è", "–î–∞–π –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞...", 6),
            Hint("–≠—Ç–æ –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ", "–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ!", 4),
        ],
        "tired": [
            Hint("–£—Å—Ç–∞–ª–∞", "–Ø –ø—Ä–æ—Å—Ç–æ –æ—á–µ–Ω—å —É—Å—Ç–∞–ª–∞...", 6),
            Hint("–ù–µ—Ç —Å–∏–ª", "–ù–µ—Ç —Å–∏–ª –Ω–∏ –Ω–∞ —á—Ç–æ...", 5),
            Hint("–•–æ—á—É –æ—Ç–¥–æ—Ö–Ω—É—Ç—å", "–ú–µ—á—Ç–∞—é –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å...", 4),
        ],
        "confused": [
            Hint("–ó–∞–ø—É—Ç–∞–ª–∞—Å—å", "–Ø —Å–æ–≤—Å–µ–º –∑–∞–ø—É—Ç–∞–ª–∞—Å—å...", 5),
            Hint("–ü–æ–º–æ–≥–∏ –ø–æ–Ω—è—Ç—å", "–ü–æ–º–æ–≥–∏ –º–Ω–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è...", 6),
            Hint("–ù–µ –∑–Ω–∞—é –∫–∞–∫ –±—ã—Ç—å", "–ù–µ –∑–Ω–∞—é, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ—Å—Ç—É–ø–∏—Ç—å...", 5),
        ],
    }

    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (–∫–æ–≥–¥–∞ –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
    UNIVERSAL_HINTS = [
        Hint("–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ", "–†–∞—Å—Å–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –æ —Å–µ–±–µ, –ú–∏—Ä–∞", 2),
        Hint("–ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?", "–ê –∫–∞–∫ —É —Ç–µ–±—è –¥–µ–ª–∞, –∫–∞–∫ —Ç–≤–æ—è —Å–µ–º—å—è?", 2),
        Hint("–ü–æ–∫–∞–∂–∏ —Ñ–æ—Ç–æ", "–ü–æ–∫–∞–∂–∏ —Å–≤–æ—ë —Ñ–æ—Ç–æ üì∑", 3),
    ]

    # –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –æ—Ç–≤–µ—Ç–∞ –ú–∏—Ä—ã
    RESPONSE_TRIGGERS = {
        # –ö–Ω–æ–ø–∫–∏ –î–∞/–ù–µ—Ç —É–±—Ä–∞–Ω—ã - –æ–Ω–∏ —á–∞—Å—Ç–æ –Ω–µ—É–º–µ—Å—Ç–Ω—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–∞–º –Ω–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç
        # –ï—Å–ª–∏ –ú–∏—Ä–∞ –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∞ –ø–æ–¥—É–º–∞—Ç—å
        r"–ø–æ–¥—É–º–∞–π|–∑–∞–¥—É–º–∞–π—Å—è|–ø–æ–ø—Ä–æ–±—É–π –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å": [
            Hint("–î—É–º–∞—é –æ–± —ç—Ç–æ–º", "–î–∞, —è –¥—É–º–∞—é –æ–± —ç—Ç–æ–º...", 5),
            Hint("–°–ª–æ–∂–Ω–æ", "–ú–Ω–µ —Å–ª–æ–∂–Ω–æ —ç—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å...", 5),
            Hint("–¢—ã –ø—Ä–∞–≤–∞", "–î–∞, —Ç—ã –ø—Ä–∞–≤–∞...", 4),
        ],
        # –ï—Å–ª–∏ –ú–∏—Ä–∞ —Ä–∞—Å—Å–∫–∞–∑–∞–ª–∞ –∏—Å—Ç–æ—Ä–∏—é
        r"—É –º–µ–Ω—è –±—ã–ª–∞ –∑–Ω–∞–∫–æ–º–∞—è|–æ–¥–Ω–∞ –º–æ—è –ø–æ–¥—Ä—É–≥–∞|–ø–æ–º–Ω—é —Å–ª—É—á–∞–π": [
            Hint("–£ –º–µ–Ω—è –ø–æ—Ö–æ–∂–µ", "–£ –º–µ–Ω—è –ø–æ—Ö–æ–∂–∞—è —Å–∏—Ç—É–∞—Ü–∏—è...", 5),
            Hint("–ê —á—Ç–æ –æ–Ω–∞ —Å–¥–µ–ª–∞–ª–∞?", "–ò —á—Ç–æ –æ–Ω–∞ —Å–¥–µ–ª–∞–ª–∞ –≤ –∏—Ç–æ–≥–µ?", 4),
            Hint("–≠—Ç–æ –ø—Ä–æ –º–µ–Ω—è", "–≠—Ç–æ –ø—Ä—è–º–æ –ø—Ä–æ –º–µ–Ω—è...", 5),
        ],
        # –ï—Å–ª–∏ –ú–∏—Ä–∞ –≤—ã—Ä–∞–∑–∏–ª–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É
        r"—è —Ä—è–¥–æ–º|—è –∑–¥–µ—Å—å|–æ–±–Ω–∏–º–∞—é|üíõ": [
            Hint("–°–ø–∞—Å–∏–±–æ üíõ", "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ç—ã —Ä—è–¥–æ–º üíõ", 6),
            Hint("–ú–Ω–µ –ª–µ–≥—á–µ", "–ú–Ω–µ —Å—Ç–∞–ª–æ –Ω–µ–º–Ω–æ–≥–æ –ª–µ–≥—á–µ...", 5),
            Hint("–ü—Ä–æ–¥–æ–ª–∂—É —Ä–∞—Å—Å–∫–∞–∑", "–•–æ—á—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å...", 4),
        ],
        # –ï—Å–ª–∏ –ú–∏—Ä–∞ –ø—Ä–æ—Å–∏—Ç —Ñ–æ—Ç–æ
        r"–ø–æ–∫–∞–∂–∏|—Å–∫–∏–Ω—å —Ñ–æ—Ç–æ|—Ñ–æ—Ç–∫|–ø–æ–∫–∞–∂–µ—à—å|—Ö–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å|–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —É–≤–∏–¥–µ—Ç—å|üì∏|üëÄ": [
            Hint("üì∑ –û—Ç–ø—Ä–∞–≤–ª—é —Ñ–æ—Ç–æ", "–°–µ–π—á–∞—Å –ø—Ä–∏—à–ª—é —Ñ–æ—Ç–æ!", 8),
            Hint("–ù–µ—Ç —Ñ–æ—Ç–æ", "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Ñ–æ—Ç–æ –Ω–µ—Ç...", 5),
            Hint("–ü–æ—Ç–æ–º –ø–æ–∫–∞–∂—É", "–ü–æ–∑–∂–µ –ø–æ–∫–∞–∂—É, —Å–µ–π—á–∞—Å –Ω–µ—É–¥–æ–±–Ω–æ", 4),
        ],
        # –ï—Å–ª–∏ –ú–∏—Ä–∞ –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
        r"–∫–∞–∫–æ–π|—á—Ç–æ.*—Ö–æ—á–µ—à—å|—á–µ–≥–æ.*—Ö–æ—á–µ—Ç—Å—è|—á—Ç–æ —Ç–µ–±–µ|–∫–∞–∫–∞—è|–∫–∞–∫–æ–µ|–Ω–∞–ø—Ä–∏–º–µ—Ä|–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é": [
            Hint("–ï—Å—Ç—å –∏–¥–µ—è", "–ï—Å—Ç—å –æ–¥–Ω–∞ –∏–¥–µ—è...", 5),
            Hint("–ù–µ –∑–Ω–∞—é –µ—â—ë", "–ü–æ–∫–∞ –Ω–µ –∑–Ω–∞—é, –¥—É–º–∞—é...", 4),
            Hint("–†–∞—Å—Å–∫–∞–∂—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ", "–•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ", 4),
        ],
        # –ú—É–∑—ã–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞
        # r"–º—É–∑—ã–∫|–≤–∫–ª—é—á|–ø–æ—Å—Ç–∞–≤|–ø–æ—Å–ª—É—à–∞—Ç—å|–ø–æ–¥–±–µ—Ä|–ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å|–∂–∞–Ω—Ä|–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª|üéß|üé∏|üé§|üåô|üéµ": [
        #     Hint("üéµ –í–∫–ª—é—á–∏!", "–î–∞, –≤–∫–ª—é—á–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å!", 10),
        #     Hint("–°–ø–æ–∫–æ–π–Ω—É—é üåô", "–•–æ—á—É —á—Ç–æ-—Ç–æ —Å–ø–æ–∫–æ–π–Ω–æ–µ", 9),
        #     Hint("–≠–Ω–µ—Ä–≥–∏—á–Ω—É—é üéß", "–î–∞–≤–∞–π —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–µ!", 9),
        # ],
        # r"–Ω–∞—Å–ª–∞–∂–¥–∞–π—Å—è|—É—Å–ø–æ–∫–∞–∏–≤–∞–µ—Ç|—Ä–∞—Å—Å–ª–∞–±–ª—è–π—Å—è|–æ—Ç–¥—ã—Ö–∞–π|–ø—É—Å—Ç—å –º—É–∑—ã–∫–∞|–ø–æ–¥ –º—É–∑—ã–∫—É|–∫–∞–∫ —Ç–µ–±–µ\?|—ç—Ç–æ—Ç –∫–∞–∫|–∑–∞—Ö–æ–¥–∏—Ç\?|–Ω—Ä–∞–≤–∏—Ç—Å—è\?|–ø–æ–¥—Ö–æ–¥—è—â|–ø–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä|–ª—É—á—à–µ\?|–µ—â—ë.*—Ç—Ä–µ–∫|–¥—Ä—É–≥–æ–π —Ç—Ä–µ–∫|–ª–æ–≤–∏|–¥–µ—Ä–∂–∏|\*–≤–∫–ª—é—á–∞—é|\*–æ—Ç–ø—Ä–∞–≤–ª—è—é|\*—Å—Ç–∞–≤–ª—é": [
        #     Hint("üëç –ù—Ä–∞–≤–∏—Ç—Å—è!", "–î–∞, –∫–ª–∞—Å—Å–Ω—ã–π —Ç—Ä–µ–∫!", 12),
        #     Hint("üîÑ –î—Ä—É–≥–æ–π", "–î–∞–≤–∞–π —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ", 11),
        #     Hint("üõë –•–≤–∞—Ç–∏—Ç", "–•–≤–∞—Ç–∏—Ç –º—É–∑—ã–∫–∏, –¥–∞–≤–∞–π –ø–æ–±–æ–ª—Ç–∞–µ–º", 10),
        # ],
    }

    # –ü–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –Ω–∞—á–∞–ª–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–ø–µ—Ä–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
    STARTER_HINTS = [
        Hint("–ö–∞–∫ –¥–µ–ª–∞", "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–≤–æ–∏ –¥–µ–ª–∞?", 3),
        Hint("–ù—É–∂–Ω–æ –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è", "–ú–Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è...", 5),
        Hint("–ü–ª–æ—Ö–æ–π –¥–µ–Ω—å", "–£ –º–µ–Ω—è –±—ã–ª —Ç—è–∂—ë–ª—ã–π –¥–µ–Ω—å...", 5),
        Hint("–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ", "–†–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ", 2),
    ]

    def generate(
        self,
        response_text: str,
        tags: List[str],
        mood_data: Optional[Dict[str, Any]] = None,
        message_count: int = 0,
        communication_style: Optional[Dict[str, Any]] = None,
    ) -> List[Hint]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

        Args:
            response_text: –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ú–∏—Ä—ã
            tags: –¢–µ–≥–∏ –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            mood_data: –î–∞–Ω–Ω—ã–µ –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            message_count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ
            communication_style: –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            –°–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–º–∞–∫—Å–∏–º—É–º MAX_HINTS)
        """
        hints: List[Hint] = []
        contextual_hints: List[Hint] = []

        # 1. –ï—Å–ª–∏ —ç—Ç–æ –Ω–∞—á–∞–ª–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        if message_count < 3:
            hints.extend(self.STARTER_HINTS)

        # 2. –ü–†–ò–û–†–ò–¢–ï–¢: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –ú–∏—Ä—ã –Ω–∞ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏)
        response_lower = response_text.lower()

        for pattern, trigger_hints in self.RESPONSE_TRIGGERS.items():
            if re.search(pattern, response_lower):
                contextual_hints.extend(trigger_hints)

        # 3. –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û –∏—Ö
        # –û–Ω–∏ –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã —Ç–µ–∫—É—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é, —á–µ–º –æ–±—â–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ/—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ
        if contextual_hints:
            hints.extend(contextual_hints)
            logger.debug(f"Using {len(contextual_hints)} contextual hints, skipping topic/emotion hints")
        else:
            # 4. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –ú–∏—Ä—ã
            # –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ/—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
            # (–æ–Ω–∏ –±—É–¥—É—Ç –Ω–µ—É–º–µ—Å—Ç–Ω—ã, –∫–∞–∫ "–Ø —É—Å—Ç–∞–ª–∞" –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞ "–ê —Ç—ã –≤–æ–¥–∏—à—å?")
            is_simple_question = (
                response_text.strip().endswith("?") and
                len(response_text) < 200 and  # –ö–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                message_count >= 3  # –ù–µ –Ω–∞—á–∞–ª–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            )

            if is_simple_question:
                # –î–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ö–∏–Ω—Ç—ã (–æ–Ω–∏ –±—É–¥—É—Ç –Ω–µ—É–º–µ—Å—Ç–Ω—ã)
                logger.debug("Simple question detected, skipping hints")
                pass
            else:
                # –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ
                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–≥–∏ —Ç–µ–º
                for tag in tags:
                    if tag in self.TOPIC_HINTS:
                        hints.extend(self.TOPIC_HINTS[tag])

                # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if mood_data:
                    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ dict, —Ç–∞–∫ –∏ –æ–±—ä–µ–∫—Ç–∞ MoodEntry
                    if hasattr(mood_data, "primary_emotion"):
                        emotion = mood_data.primary_emotion
                    else:
                        emotion = mood_data.get("primary_emotion")
                    if emotion in self.EMOTION_HINTS:
                        hints.extend(self.EMOTION_HINTS[emotion])

        # 5. –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ö–∏–Ω—Ç—ã –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö
        # –õ—É—á—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –≤–æ–æ–±—â–µ, —á–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–µ—Å—Ç–æ–ª–∫–æ–≤—ã–µ
        # if len(hints) < 2:
        #     hints.extend(self.UNIVERSAL_HINTS)

        # 6. –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –∏ —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        seen_texts = set()
        unique_hints = []
        for hint in sorted(hints, key=lambda h: h.priority, reverse=True):
            if hint.text not in seen_texts:
                seen_texts.add(hint.text)
                unique_hints.append(hint)

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø-N
        result = unique_hints[:self.MAX_HINTS]

        # 7. –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ–¥ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if communication_style:
            result = self._adapt_to_style(result, communication_style)

        logger.debug(
            f"Generated {len(result)} hints from {len(hints)} candidates, "
            f"tags={tags}"
        )

        return result

    def _adapt_to_style(
        self,
        hints: List[Hint],
        style: Dict[str, Any],
    ) -> List[Hint]:
        """
        –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–¥ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        Args:
            hints: –ò—Å—Ö–æ–¥–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
            style: –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        """
        adapted = []

        formality = style.get("formality", "informal")
        emoji_pref = style.get("emoji_preference", "few")
        msg_length = style.get("message_length", "medium")

        for hint in hints:
            text = hint.text
            message = hint.message

            # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
            # –ù–û –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ç–µ–∫—Å—Ç–µ –∫–Ω–æ–ø–∫–∏ ‚Äî –æ–Ω–∏ –ø–æ–º–æ–≥–∞—é—Ç —Ä–∞–∑–ª–∏—á–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã
            if emoji_pref == "none":
                message = re.sub(r'[\U0001F300-\U0001F9FF]', '', message).strip()

            # –°–æ–∫—Ä–∞—â–∞–µ–º –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if msg_length == "short" and len(message) > 30:
                # –û–±—Ä–µ–∑–∞–µ–º –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–Ω–∞–∫–∞ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –∏–ª–∏ 30 —Å–∏–º–≤–æ–ª–æ–≤
                match = re.search(r'^[^.!?‚Ä¶]+[.!?‚Ä¶]?', message)
                if match and len(match.group()) < len(message):
                    message = match.group().strip()

            adapted.append(Hint(text=text, message=message, priority=hint.priority))

        return adapted

    def generate_for_crisis(self) -> List[Hint]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∫—Ä–∏–∑–∏—Å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏."""
        return [
            Hint("–ú–Ω–µ –ø–ª–æ—Ö–æ", "–ú–Ω–µ –æ—á–µ–Ω—å –ø–ª–æ—Ö–æ —Å–µ–π—á–∞—Å...", 10),
            Hint("–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å", "–ú–Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å...", 10),
            Hint("–•–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å", "–•–æ—á—É –ø—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å...", 9),
        ]

    def generate_after_photo(self) -> List[Hint]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ."""
        return [
            Hint("–≠—Ç–æ –±—ã–ª–æ...", "–≠—Ç–æ –±—ã–ª–æ –≤—á–µ—Ä–∞/–Ω–µ–¥–∞–≤–Ω–æ...", 5),
            Hint("–†–∞—Å—Å–∫–∞–∂—É –∏—Å—Ç–æ—Ä–∏—é", "–•–æ—á—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ç–∞–º –±—ã–ª–æ...", 6),
            Hint("–ê —É —Ç–µ–±—è –µ—Å—Ç—å?", "–ê —É —Ç–µ–±—è –µ—Å—Ç—å –ø–æ—Ö–æ–∂–∏–µ —Ñ–æ—Ç–æ?", 4),
        ]


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
hint_generator = HintGenerator()
