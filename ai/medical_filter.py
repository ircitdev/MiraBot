"""
Medical Filter.
–§–∏–ª—å—Ç—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ –≤ –æ—Ç–≤–µ—Ç–∞—Ö –±–æ—Ç–∞.
"""

import re
from typing import Tuple, Optional
from loguru import logger


# –ú–∞—Ä–∫–µ—Ä—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ç–µ–º—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
MEDICAL_TOPIC_MARKERS = [
    # –°–∏–º–ø—Ç–æ–º—ã
    "–±–æ–ª–∏—Ç", "–±–æ–ª—å", "—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä", "–¥–∞–≤–ª–µ–Ω–∏", "—Ç–æ—à–Ω–∏—Ç", "–∫—Ä—É–∂–∏—Ç—Å—è –≥–æ–ª–æ–≤–∞",
    "—Å–ª–∞–±–æ—Å—Ç—å", "–æ–∑–Ω–æ–±", "–∫–∞—à–µ–ª—å", "–Ω–∞—Å–º–æ—Ä–∫", "–≥–æ—Ä–ª–æ",
    # –õ–µ–∫–∞—Ä—Å—Ç–≤–∞
    "–ª–µ–∫–∞—Ä—Å—Ç–≤", "—Ç–∞–±–ª–µ—Ç–∫", "–ø—Ä–µ–ø–∞—Ä–∞—Ç", "–∞–Ω—Ç–∏–±–∏–æ—Ç–∏–∫", "–æ–±–µ–∑–±–æ–ª–∏–≤–∞",
    "–∂–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â", "–≤–∏—Ç–∞–º–∏–Ω", "–±–∞–¥", "–∫–∞–ø–ª–∏", "–º–∞–∑—å", "—É–∫–æ–ª",
    # –ú–µ–¥–∏—Ü–∏–Ω–∞
    "–¥–∏–∞–≥–Ω–æ–∑", "–∞–Ω–∞–ª–∏–∑", "–≤—Ä–∞—á", "–±–æ–ª—å–Ω–∏—Ü", "–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫", "—Ä–µ—Ü–µ–ø—Ç",
    "—Å–∏–º–ø—Ç–æ–º", "–∑–∞–±–æ–ª–µ–≤–∞–Ω", "–±–æ–ª–µ–∑–Ω", "–ª–µ—á–µ–Ω–∏", "–æ–ø–µ—Ä–∞—Ü–∏",
    # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±–æ–ª–µ–∑–Ω–∏
    "–ø—Ä–æ—Å—Ç—É–¥", "–≥—Ä–∏–ø–ø", "–∫–æ–≤–∏–¥", "–æ—Ä–≤–∏", "–æ—Ä–∑", "–∞–Ω–≥–∏–Ω", "–±—Ä–æ–Ω—Ö–∏—Ç",
    "–≥–∞—Å—Ç—Ä–∏—Ç", "–¥–∞–≤–ª–µ–Ω–∏–µ", "–º–∏–≥—Ä–µ–Ω", "–∞–ª–ª–µ—Ä–≥–∏",
]

# –ü–∞—Ç—Ç–µ—Ä–Ω—ã –æ–ø–∞—Å–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ –±–æ—Ç–∞
DANGEROUS_ADVICE_PATTERNS = [
    # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ª–µ–∫–∞—Ä—Å—Ç–≤
    r"(–ø–æ–ø–µ–π|–ø—Ä–∏–º–∏|–≤—ã–ø–µ–π|–ø–æ–ø—Ä–æ–±—É–π)\s+\w*(–ø–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª|–∏–±—É–ø—Ä–æ—Ñ–µ–Ω|–∞—Å–ø–∏—Ä–∏–Ω|–Ω—É—Ä–æ—Ñ–µ–Ω|–∞–Ω–∞–ª—å–≥–∏–Ω|—Ü–∏—Ç—Ä–∞–º–æ–Ω|–Ω–æ-—à–ø–∞|—Å–º–µ–∫—Ç–∞|–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É–≥–æ–ª—å)",
    r"(—Ä–µ–∫–æ–º–µ–Ω–¥—É—é|—Å–æ–≤–µ—Ç—É—é|–ø–æ–ø—Ä–æ–±—É–π)\s+\w*\s*(—Ç–∞–±–ª–µ—Ç–∫|–ª–µ–∫–∞—Ä—Å—Ç–≤|–ø—Ä–µ–ø–∞—Ä–∞—Ç|–∞–Ω—Ç–∏–±–∏–æ—Ç–∏–∫)",
    r"(–Ω—É–∂–µ–Ω|–Ω—É–∂–Ω–æ|–Ω–∞–¥–æ)\s+\w*\s*(–∞–Ω—Ç–∏–±–∏–æ—Ç–∏–∫|–ª–µ–∫–∞—Ä—Å—Ç–≤|–ø—Ä–µ–ø–∞—Ä–∞—Ç)",
    # –î–æ–∑–∏—Ä–æ–≤–∫–∏
    r"\d+\s*(–º–≥|–º–ª|—Ç–∞–±–ª–µ—Ç|–∫–∞–ø—Å—É–ª|–∫–∞–ø–µ–ª—å)",
    r"(–ø–æ|–ø—Ä–∏–Ω–∏–º–∞–π)\s+\d+\s*(—Ä–∞–∑|—Ç–∞–±–ª–µ—Ç)",
    # –î–∏–∞–≥–Ω–æ–∑—ã
    r"(—ç—Ç–æ|–ø–æ—Ö–æ–∂–µ –Ω–∞|—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ)\s+(–º–∏–≥—Ä–µ–Ω|–≥–∞—Å—Ç—Ä–∏—Ç|–ø—Ä–æ—Å—Ç—É–¥|–≥—Ä–∏–ø–ø|–∞–ª–ª–µ—Ä–≥–∏|–æ—Ç—Ä–∞–≤–ª–µ–Ω)",
    r"(—É —Ç–µ–±—è|—ç—Ç–æ)\s+\w*\s*(–∑–∞–±–æ–ª–µ–≤–∞–Ω|–±–æ–ª–µ–∑–Ω|—Å–∏–Ω–¥—Ä–æ–º|—Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤)",
]

# –ú—è–≥–∫–∏–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
MEDICAL_DISCLAIMER = "\n\nüíõ –ù–æ —è –Ω–µ –≤—Ä–∞—á ‚Äî –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç, –ª—É—á—à–µ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Å—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º."

# –ö–æ—Ä–æ—Ç–∫–∏–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–Ω–µ—Ü
SHORT_DISCLAIMER = " (–Ω–æ –≤—Ä–∞—á —Å–∫–∞–∂–µ—Ç —Ç–æ—á–Ω–µ–µ)"


class MedicalFilter:
    """–§–∏–ª—å—Ç—Ä –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ –≤ –æ—Ç–≤–µ—Ç–∞—Ö –±–æ—Ç–∞."""

    def is_medical_topic(self, user_message: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π —Ç–µ–º–æ–π.

        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            True –µ—Å–ª–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Ç–µ–º–∞
        """
        message_lower = user_message.lower()

        for marker in MEDICAL_TOPIC_MARKERS:
            if marker in message_lower:
                logger.debug(f"Medical topic detected: '{marker}'")
                return True

        return False

    def has_dangerous_advice(self, response: str) -> Tuple[bool, Optional[str]]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç –æ–ø–∞—Å–Ω—ã–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã.

        Args:
            response: –û—Ç–≤–µ—Ç –±–æ—Ç–∞

        Returns:
            (has_dangerous, matched_pattern)
        """
        response_lower = response.lower()

        for pattern in DANGEROUS_ADVICE_PATTERNS:
            match = re.search(pattern, response_lower)
            if match:
                logger.warning(f"Dangerous medical advice detected: '{match.group()}'")
                return True, match.group()

        return False, None

    def needs_disclaimer(self, user_message: str, response: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –∫ –æ—Ç–≤–µ—Ç—É.

        –î–∏—Å–∫–ª–µ–π–º–µ—Ä –Ω—É–∂–µ–Ω –µ—Å–ª–∏:
        1. –¢–µ–º–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è
        2. –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–≤–µ—Ç—ã (–¥–∞–∂–µ –±–µ–∑–æ–±–∏–¥–Ω—ã–µ)
        3. –û—Ç–≤–µ—Ç –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∂–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤—Ä–∞—á–∞

        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            response: –û—Ç–≤–µ—Ç –±–æ—Ç–∞

        Returns:
            True –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –¥–∏—Å–∫–ª–µ–π–º–µ—Ä
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é —Ç–µ–º—É
        if not self.is_medical_topic(user_message):
            return False

        response_lower = response.lower()

        # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤—Ä–∞—á–∞ ‚Äî –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –Ω–µ –Ω—É–∂–µ–Ω
        doctor_mentions = ["–≤—Ä–∞—á", "–¥–æ–∫—Ç–æ—Ä", "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "—Ç–µ—Ä–∞–ø–µ–≤—Ç", "–Ω–µ–≤—Ä–æ–ª–æ–≥", "–ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä"]
        for mention in doctor_mentions:
            if mention in response_lower:
                return False

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Å–æ–≤–µ—Ç—ã –≤ –æ—Ç–≤–µ—Ç–µ
        advice_markers = [
            "–ø–æ–ø—Ä–æ–±—É–π", "–ø–æ–ø–µ–π", "–ø—Ä–∏–º–∏", "–æ—Ç–¥–æ—Ö–Ω–∏", "–ø–æ—Å–ø–∏", "–≤—ã–ø–µ–π",
            "–ø—Ä–∏–ª–æ–∂–∏", "–ø–æ–º–∞—Å—Å–∏—Ä—É–π", "—Å–æ–≥—Ä–µ–π", "–æ—Ö–ª–∞–¥–∏",
        ]

        for marker in advice_markers:
            if marker in response_lower:
                return True

        return False

    def filter_response(self, user_message: str, response: str) -> str:
        """
        –§–∏–ª—å—Ç—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –±–æ—Ç–∞, –¥–æ–±–∞–≤–ª—è—è –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.

        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            response: –û—Ç–≤–µ—Ç –±–æ—Ç–∞

        Returns:
            –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–≤–æ–∑–º–æ–∂–Ω–æ —Å –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–æ–º)
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–∞—Å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
        has_dangerous, pattern = self.has_dangerous_advice(response)

        if has_dangerous:
            logger.warning(f"Filtering dangerous medical advice: {pattern}")
            # –î–ª—è –æ–ø–∞—Å–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–Ω—ã–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä
            if MEDICAL_DISCLAIMER.strip() not in response:
                return response.rstrip() + MEDICAL_DISCLAIMER

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–µ–Ω –ª–∏ –º—è–≥–∫–∏–π –¥–∏—Å–∫–ª–µ–π–º–µ—Ä
        if self.needs_disclaimer(user_message, response):
            logger.debug("Adding medical disclaimer to response")
            if MEDICAL_DISCLAIMER.strip() not in response:
                return response.rstrip() + MEDICAL_DISCLAIMER

        return response


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
medical_filter = MedicalFilter()
